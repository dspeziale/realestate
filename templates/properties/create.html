<!-- Copyright 2025 SILICONDEV SPA -->
<!-- Filename: templates/properties/create.html -->
<!-- Description: Property creation form -->

{% extends "base.html" %}

{% block title %}Nuovo Immobile - AsteImmobili{% endblock %}

{% block page_title %}Nuovo Immobile{% endblock %}

{% block page_actions %}
    <a href="{{ url_for('properties.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Torna ai Immobili
    </a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <form method="POST" action="{{ url_for('properties.create') }}" class="needs-validation" novalidate>

            <!-- Informazioni Generali -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informazioni Generali
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">Titolo Immobile *</label>
                            <input type="text" class="form-control" id="title" name="title"
                                   placeholder="Es: Appartamento di 90 mq in centro storico"
                                   maxlength="200" required>
                            <div class="invalid-feedback">
                                Il titolo è richiesto.
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="property_type" class="form-label">Tipo Immobile *</label>
                            <select class="form-select" id="property_type" name="property_type" required>
                                <option value="">Seleziona tipo...</option>
                                <option value="apartment">Appartamento</option>
                                <option value="villa">Villa</option>
                                <option value="house">Casa</option>
                                <option value="office">Ufficio</option>
                                <option value="commercial">Commerciale</option>
                                <option value="industrial">Industriale</option>
                                <option value="land">Terreno</option>
                                <option value="garage">Garage</option>
                                <option value="other">Altro</option>
                            </select>
                            <div class="invalid-feedback">
                                Seleziona il tipo di immobile.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Descrizione</label>
                        <textarea class="form-control" id="description" name="description"
                                  rows="3" placeholder="Descrizione dettagliata dell'immobile..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Ubicazione -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt me-2"></i>
                        Ubicazione
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="address" class="form-label">Indirizzo *</label>
                            <input type="text" class="form-control" id="address" name="address"
                                   placeholder="Via, numero civico" maxlength="200" required>
                            <div class="invalid-feedback">
                                L'indirizzo è richiesto.
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="postal_code" class="form-label">CAP</label>
                            <input type="text" class="form-control" id="postal_code" name="postal_code"
                                   placeholder="00000" maxlength="20">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="city" class="form-label">Città *</label>
                            <input type="text" class="form-control" id="city" name="city"
                                   placeholder="Nome città" maxlength="100" required>
                            <div class="invalid-feedback">
                                La città è richiesta.
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="province" class="form-label">Provincia *</label>
                            <input type="text" class="form-control" id="province" name="province"
                                   placeholder="Es: RM, MI, NA" maxlength="50" required>
                            <div class="invalid-feedback">
                                La provincia è richiesta.
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="region" class="form-label">Regione</label>
                            <select class="form-select" id="region" name="region">
                                <option value="">Seleziona regione...</option>
                                <option value="Abruzzo">Abruzzo</option>
                                <option value="Basilicata">Basilicata</option>
                                <option value="Calabria">Calabria</option>
                                <option value="Campania">Campania</option>
                                <option value="Emilia-Romagna">Emilia-Romagna</option>
                                <option value="Friuli-Venezia Giulia">Friuli-Venezia Giulia</option>
                                <option value="Lazio">Lazio</option>
                                <option value="Liguria">Liguria</option>
                                <option value="Lombardia">Lombardia</option>
                                <option value="Marche">Marche</option>
                                <option value="Molise">Molise</option>
                                <option value="Piemonte">Piemonte</option>
                                <option value="Puglia">Puglia</option>
                                <option value="Sardegna">Sardegna</option>
                                <option value="Sicilia">Sicilia</option>
                                <option value="Toscana">Toscana</option>
                                <option value="Trentino-Alto Adige">Trentino-Alto Adige</option>
                                <option value="Umbria">Umbria</option>
                                <option value="Valle d'Aosta">Valle d'Aosta</option>
                                <option value="Veneto">Veneto</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Caratteristiche -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-house-door me-2"></i>
                        Caratteristiche
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="condition" class="form-label">Condizioni</label>
                            <select class="form-select" id="condition" name="condition">
                                <option value="">Seleziona...</option>
                                <option value="excellent">Ottimo</option>
                                <option value="good">Buono</option>
                                <option value="fair">Discreto</option>
                                <option value="poor">Da ristrutturare</option>
                                <option value="to_renovate">Da rifare</option>
                            </select>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="surface_area" class="form-label">Superficie (mq)</label>
                            <input type="number" class="form-control" id="surface_area" name="surface_area"
                                   placeholder="90" step="0.1" min="1">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="rooms" class="form-label">Vani</label>
                            <input type="number" class="form-control" id="rooms" name="rooms"
                                   placeholder="4" min="1" max="20">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="bathrooms" class="form-label">Bagni</label>
                            <input type="number" class="form-control" id="bathrooms" name="bathrooms"
                                   placeholder="2" min="1" max="10">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="floor" class="form-label">Piano</label>
                            <input type="text" class="form-control" id="floor" name="floor"
                                   placeholder="Es: 2°, PT, S1" maxlength="20">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="year_built" class="form-label">Anno Costruzione</label>
                            <input type="number" class="form-control" id="year_built" name="year_built"
                                   placeholder="1990" min="1800" max="2024">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="energy_class" class="form-label">Classe Energetica</label>
                            <select class="form-select" id="energy_class" name="energy_class">
                                <option value="">Seleziona...</option>
                                <option value="A+">A+</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                            </select>
                        </div>
                    </div>

                    <!-- Features Checkboxes -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Dotazioni</label>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="has_garage" name="has_garage">
                                        <label class="form-check-label" for="has_garage">
                                            <i class="bi bi-car-front me-1"></i>
                                            Garage/Posto Auto
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="has_garden" name="has_garden">
                                        <label class="form-check-label" for="has_garden">
                                            <i class="bi bi-tree me-1"></i>
                                            Giardino
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="has_terrace" name="has_terrace">
                                        <label class="form-check-label" for="has_terrace">
                                            <i class="bi bi-sun me-1"></i>
                                            Terrazza/Balcone
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="has_elevator" name="has_elevator">
                                        <label class="form-check-label" for="has_elevator">
                                            <i class="bi bi-arrow-up me-1"></i>
                                            Ascensore
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informazioni Economiche -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-currency-euro me-2"></i>
                        Informazioni Economiche
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="base_price" class="form-label">Prezzo Base Asta *</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control price-input" id="base_price" name="base_price"
                                       placeholder="150000" step="1000" min="1" required>
                            </div>
                            <div class="invalid-feedback">
                                Il prezzo base deve essere maggiore di zero.
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="estimated_value" class="form-label">Valore di Stima</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control price-input" id="estimated_value" name="estimated_value"
                                       placeholder="200000" step="1000" min="1">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="minimum_bid" class="form-label">Offerta Minima</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control price-input" id="minimum_bid" name="minimum_bid"
                                       placeholder="100000" step="1000" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cadastral_income" class="form-label">Rendita Catastale</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control" id="cadastral_income" name="cadastral_income"
                                       placeholder="800" step="0.01" min="0">
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="has_debts" name="has_debts">
                                <label class="form-check-label" for="has_debts">
                                    <strong>L'immobile ha debiti/gravami</strong>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="debt_info" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label for="debt_amount" class="form-label">Importo Debiti</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control" id="debt_amount" name="debt_amount"
                                       placeholder="50000" step="1000" min="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informazioni Legali -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text me-2"></i>
                        Informazioni Legali
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="court" class="form-label">Tribunale</label>
                            <input type="text" class="form-control" id="court" name="court"
                                   placeholder="Tribunale di Roma" maxlength="100">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="procedure_number" class="form-label">N° Procedura</label>
                            <input type="text" class="form-control" id="procedure_number" name="procedure_number"
                                   placeholder="R.G.E. 123/2024" maxlength="50">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="judge" class="form-label">Giudice</label>
                            <input type="text" class="form-control" id="judge" name="judge"
                                   placeholder="Nome giudice" maxlength="100">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cadastral_data" class="form-label">Dati Catastali</label>
                        <textarea class="form-control" id="cadastral_data" name="cadastral_data"
                                  rows="2" placeholder="Foglio, particella, subalterno, categoria, classe..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_occupied" name="is_occupied">
                                <label class="form-check-label" for="is_occupied">
                                    <i class="bi bi-people me-1"></i>
                                    <strong>Immobile occupato</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assegnazione Agente (Solo Admin) -->
            {% if current_user.is_admin and agents %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>
                        Assegnazione
                    </h5>
                </div>
                <div class="card-body">
                    <div class="col-md-6">
                        <label for="agent_id" class="form-label">Agente Responsabile</label>
                        <select class="form-select" id="agent_id" name="agent_id">
                            <option value="{{ current_user.id }}" selected>{{ current_user.full_name }} (Me)</option>
                            {% for agent in agents %}
                                {% if agent.id != current_user.id %}
                                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Submit Buttons -->
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg me-3">
                        <i class="bi bi-check-circle me-2"></i>
                        Crea Immobile
                    </button>

                    <a href="{{ url_for('properties.index') }}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle me-2"></i>
                        Annulla
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-section {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.card-header h5 {
    font-weight: 600;
}

.price-input {
    font-weight: 600;
    text-align: right;
}

.form-check-label {
    font-weight: 500;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #ced4da;
}

@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Show/hide debt information
    const hasDebtsCheckbox = document.getElementById('has_debts');
    const debtInfo = document.getElementById('debt_info');

    hasDebtsCheckbox.addEventListener('change', function() {
        if (this.checked) {
            debtInfo.style.display = 'block';
            debtInfo.querySelector('#debt_amount').required = true;
        } else {
            debtInfo.style.display = 'none';
            debtInfo.querySelector('#debt_amount').required = false;
            debtInfo.querySelector('#debt_amount').value = '';
        }
    });

    // Auto-format price inputs
    const priceInputs = document.querySelectorAll('.price-input');
    priceInputs.forEach(function(input) {
        input.addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (!isNaN(value)) {
                this.value = value.toLocaleString('it-IT');
            }
        });

        input.addEventListener('focus', function() {
            this.value = this.value.replace(/\./g, '');
        });
    });

    // Auto-calculate minimum bid based on base price
    const basePriceInput = document.getElementById('base_price');
    const minimumBidInput = document.getElementById('minimum_bid');

    basePriceInput.addEventListener('blur', function() {
        const basePrice = parseFloat(this.value.replace(/\./g, ''));
        if (!isNaN(basePrice) && !minimumBidInput.value) {
            // Suggest 75% of base price as minimum bid
            const suggestedMinBid = Math.round(basePrice * 0.75);
            minimumBidInput.value = suggestedMinBid;
        }
    });

    // Auto-uppercase province input
    const provinceInput = document.getElementById('province');
    provinceInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    // Validate year built
    const yearBuiltInput = document.getElementById('year_built');
    yearBuiltInput.addEventListener('blur', function() {
        const year = parseInt(this.value);
        const currentYear = new Date().getFullYear();

        if (year > currentYear) {
            this.setCustomValidity('L\'anno di costruzione non può essere nel futuro');
        } else {
            this.setCustomValidity('');
        }
    });

    // Smart property type suggestions
    const titleInput = document.getElementById('title');
    const propertyTypeSelect = document.getElementById('property_type');

    titleInput.addEventListener('blur', function() {
        const title = this.value.toLowerCase();

        if (!propertyTypeSelect.value) {
            if (title.includes('appartament')) {
                propertyTypeSelect.value = 'apartment';
            } else if (title.includes('villa')) {
                propertyTypeSelect.value = 'villa';
            } else if (title.includes('casa')) {
                propertyTypeSelect.value = 'house';
            } else if (title.includes('ufficio')) {
                propertyTypeSelect.value = 'office';
            } else if (title.includes('garage') || title.includes('box')) {
                propertyTypeSelect.value = 'garage';
            } else if (title.includes('terreno')) {
                propertyTypeSelect.value = 'land';
            }
        }
    });

    // Confirm form submission
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (form.checkValidity()) {
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creazione in corso...';
        }
    });
});
</script>
{% endblock %}