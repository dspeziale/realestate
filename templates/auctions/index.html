<!-- Copyright 2025 SILICONDEV SPA -->
<!-- Filename: templates/auctions/index.html -->
<!-- Description: Auctions listing page -->

{% extends "base.html" %}

{% block title %}Aste - AsteImmobili{% endblock %}

{% block page_title %}Gestione Aste{% endblock %}

{% block page_actions %}
    {% if current_user.is_admin %}
        <a href="{{ url_for('auctions.create') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>
            Nuova Asta
        </a>
    {% endif %}
{% endblock %}

{% block content %}
<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label for="search" class="form-label">Cerca</label>
                        <input type="text" class="form-control" id="search" name="search"
                               placeholder="Titolo asta, numero, immobile..."
                               value="{{ search }}">
                    </div>

                    <div class="col-md-2">
                        <label for="status" class="form-label">Stato</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Tutti gli stati</option>
                            {% for status_value, status_label in filter_options.statuses %}
                                <option value="{{ status_value }}"
                                        {% if filters.status == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label for="auction_type" class="form-label">Tipo Asta</label>
                        <select class="form-select" id="auction_type" name="auction_type">
                            <option value="">Tutti i tipi</option>
                            {% for type_value, type_label in filter_options.auction_types %}
                                <option value="{{ type_value }}"
                                        {% if filters.auction_type == type_value %}selected{% endif %}>
                                    {{ type_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="date_range" class="form-label">Periodo</label>
                        <div class="input-group">
                            <input type="date" class="form-control" name="start_date"
                                   value="{{ filters.start_date }}">
                            <input type="date" class="form-control" name="end_date"
                                   value="{{ filters.end_date }}">
                        </div>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search me-1"></i>
                            Cerca
                        </button>
                        <a href="{{ url_for('auctions.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filter Badges -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex flex-wrap gap-2 mb-2">
            <a href="{{ url_for('auctions.index', status='active') }}"
               class="badge bg-success text-decoration-none fs-6 py-2 px-3">
                <i class="bi bi-play-circle me-1"></i>
                Aste Attive
            </a>
            <a href="{{ url_for('auctions.index', status='scheduled') }}"
               class="badge bg-primary text-decoration-none fs-6 py-2 px-3">
                <i class="bi bi-calendar me-1"></i>
                Programmate
            </a>
            <a href="{{ url_for('auctions.index', status='ended') }}"
               class="badge bg-secondary text-decoration-none fs-6 py-2 px-3">
                <i class="bi bi-stop-circle me-1"></i>
                Terminate
            </a>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">
                    Trovate {{ auctions.total }} aste
                    {% if search or filters.status or filters.auction_type %}
                        (filtrate)
                    {% endif %}
                </h6>
            </div>
            <div>
                <span class="text-muted">
                    Pagina {{ auctions.page }} di {{ auctions.pages }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Auctions Grid -->
{% if auctions.items %}
    <div class="row">
        {% for auction in auctions.items %}
            <div class="col-xl-6 col-lg-12 mb-4">
                <div class="card auction-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">
                                <a href="{{ url_for('auctions.show', auction_id=auction.id) }}"
                                   class="text-decoration-none">
                                    {{ auction.title }}
                                </a>
                            </h5>
                            <small class="text-muted">
                                N° {{ auction.auction_number }} | {{ auction.auction_type_label }}
                            </small>
                        </div>
                        <span class="badge auction-status {{ auction.status }}">
                            {{ auction.status_label }}
                        </span>
                    </div>

                    <div class="card-body">
                        <!-- Property Info -->
                        {% if auction.property %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-1">
                                    <i class="bi bi-building me-1"></i>
                                    Immobile
                                </h6>
                                <div class="d-flex justify-content-between">
                                    <span>{{ auction.property.title }}</span>
                                    <small class="text-muted">{{ auction.property.city }}</small>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Timing Information -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Data Inizio</small>
                                <div>
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ auction.start_date.strftime('%d/%m/%Y') if auction.start_date else 'N/A' }}
                                </div>
                                <div>
                                    <i class="bi bi-clock me-1"></i>
                                    {{ auction.start_date.strftime('%H:%M') if auction.start_date else 'N/A' }}
                                </div>
                            </div>
                            {% if auction.end_date %}
                            <div class="col-6">
                                <small class="text-muted d-block">Data Fine</small>
                                <div>
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ auction.end_date.strftime('%d/%m/%Y') }}
                                </div>
                                <div>
                                    <i class="bi bi-clock me-1"></i>
                                    {{ auction.end_date.strftime('%H:%M') }}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Price Information -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Prezzo Base</small>
                                <div class="fw-bold text-primary">
                                    €{{ "{:,.0f}".format(auction.starting_price) }}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    {% if auction.status == 'active' %}Prezzo Attuale{% else %}Prezzo Finale{% endif %}
                                </small>
                                <div class="fw-bold text-success">
                                    €{{ "{:,.0f}".format(auction.current_price or auction.starting_price) }}
                                </div>
                            </div>
                        </div>

                        <!-- Auction Stats -->
                        <div class="row mb-3">
                            <div class="col-4">
                                <small class="text-muted d-block">Offerte</small>
                                <div class="fw-bold">{{ auction.total_bids }}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Cauzione</small>
                                <div class="fw-bold">€{{ "{:,.0f}".format(auction.deposit_amount) }}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Incremento</small>
                                <div class="fw-bold">€{{ "{:,.0f}".format(auction.minimum_bid_increment) }}</div>
                            </div>
                        </div>

                        <!-- Time Remaining (for active auctions) -->
                        {% if auction.status == 'active' and auction.end_date %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Tempo Rimanente</small>
                                    <span class="countdown-timer badge bg-danger"
                                          data-end-time="{{ auction.end_date.isoformat() }}">
                                        Calcolo...
                                    </span>
                                </div>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Legal Info -->
                        {% if auction.court or auction.procedure_number %}
                            <div class="mb-3">
                                <small class="text-muted d-block mb-1">Informazioni Legali</small>
                                {% if auction.court %}
                                    <div><i class="bi bi-bank me-1"></i>{{ auction.court }}</div>
                                {% endif %}
                                {% if auction.procedure_number %}
                                    <div><i class="bi bi-file-text me-1"></i>Proc. {{ auction.procedure_number }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <!-- Action Buttons -->
                                <a href="{{ url_for('auctions.show', auction_id=auction.id) }}"
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>
                                    Dettagli
                                </a>

                                {% if auction.status == 'active' %}
                                    <a href="{{ url_for('auctions.show', auction_id=auction.id) }}#bid-form"
                                       class="btn btn-success btn-sm">
                                        <i class="bi bi-hand-index me-1"></i>
                                        Offri
                                    </a>
                                {% endif %}
                            </div>

                            <div>
                                <!-- Admin Actions -->
                                {% if current_user.is_admin %}
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if auction.status == 'scheduled' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('auctions.start_auction', auction_id=auction.id) }}"
                                                          style="display: inline;">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-play me-1"></i>
                                                            Avvia Asta
                                                        </button>
                                                    </form>
                                                </li>
                                            {% elif auction.status == 'active' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('auctions.end_auction', auction_id=auction.id) }}"
                                                          style="display: inline;">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-stop me-1"></i>
                                                            Termina Asta
                                                        </button>
                                                    </form>
                                                </li>
                                            {% endif %}

                                            {% if auction.status in ['scheduled', 'active'] %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('auctions.cancel_auction', auction_id=auction.id) }}"
                                                          style="display: inline;">
                                                        <button type="submit" class="dropdown-item text-danger">
                                                            <i class="bi bi-x-circle me-1"></i>
                                                            Annulla Asta
                                                        </button>
                                                    </form>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if auctions.pages > 1 %}
        <div class="row">
            <div class="col-12">
                <nav aria-label="Auctions pagination">
                    <ul class="pagination justify-content-center">
                        <!-- Previous -->
                        {% if auctions.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('auctions.index', page=auctions.prev_num,
                                    search=search, status=filters.status, auction_type=filters.auction_type) }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    <i class="bi bi-chevron-left"></i>
                                </span>
                            </li>
                        {% endif %}

                        <!-- Page Numbers -->
                        {% for page_num in auctions.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num != auctions.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('auctions.index', page=page_num,
                                            search=search, status=filters.status, auction_type=filters.auction_type) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        <!-- Next -->
                        {% if auctions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('auctions.index', page=auctions.next_num,
                                    search=search, status=filters.status, auction_type=filters.auction_type) }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    <i class="bi bi-chevron-right"></i>
                                </span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    {% endif %}

{% else %}
    <!-- No Results -->
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-hammer display-1 text-muted mb-4"></i>
                <h4 class="text-muted">Nessuna asta trovata</h4>
                {% if search or filters.status or filters.auction_type %}
                    <p class="text-muted">Prova a modificare i filtri di ricerca.</p>
                    <a href="{{ url_for('auctions.index') }}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>
                        Rimuovi Filtri
                    </a>
                {% else %}
                    <p class="text-muted">Non ci sono ancora aste registrate nel sistema.</p>
                    {% if current_user.is_admin %}
                        <a href="{{ url_for('auctions.create') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>
                            Crea Prima Asta
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.auction-card {
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.auction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.auction-status {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.auction-status.active {
    background-color: #d4edda !important;
    color: #155724 !important;
    border: 1px solid #c3e6cb;
}

.auction-status.scheduled {
    background-color: #d1ecf1 !important;
    color: #0c5460 !important;
    border: 1px solid #bee5eb;
}

.auction-status.ended {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    border: 1px solid #f5c6cb;
}

.auction-status.cancelled {
    background-color: #e2e3e5 !important;
    color: #383d41 !important;
    border: 1px solid #d6d8db;
}

.countdown-timer {
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.countdown-timer.warning {
    background-color: #fd7e14 !important;
}

.countdown-timer.danger {
    background-color: #dc3545 !important;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.7; }
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

@media (max-width: 768px) {
    .auction-card .row {
        margin-bottom: 1rem;
    }

    .auction-card .col-6,
    .auction-card .col-4 {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Countdown timer functionality
function updateCountdownTimers() {
    const timers = document.querySelectorAll('.countdown-timer');
    timers.forEach(function(timer) {
        const endTime = new Date(timer.dataset.endTime);
        const now = new Date();
        const timeLeft = endTime - now;

        if (timeLeft <= 0) {
            timer.innerHTML = '<i class="bi bi-stop-circle me-1"></i>Terminata';
            timer.classList.remove('bg-danger', 'bg-warning');
            timer.classList.add('bg-secondary');
            return;
        }

        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        let timeString = '';
        if (days > 0) {
            timeString += `${days}g `;
        }
        if (hours > 0 || days > 0) {
            timeString += `${hours.toString().padStart(2, '0')}:`;
        }
        timeString += `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        timer.textContent = timeString;

        // Update classes based on time remaining
        if (timeLeft < 3600000) { // Less than 1 hour
            timer.classList.remove('bg-warning');
            timer.classList.add('bg-danger', 'danger');
        } else if (timeLeft < 86400000) { // Less than 1 day
            timer.classList.remove('bg-danger');
            timer.classList.add('bg-warning', 'warning');
        }
    });
}

// Update countdown timers
document.addEventListener('DOMContentLoaded', function() {
    updateCountdownTimers();
    setInterval(updateCountdownTimers, 1000);

    // Confirm admin actions
    const adminForms = document.querySelectorAll('.dropdown-menu form');
    adminForms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const button = form.querySelector('button');
            const action = button.textContent.trim();

            if (!confirm(`Sei sicuro di voler ${action.toLowerCase()}?`)) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}