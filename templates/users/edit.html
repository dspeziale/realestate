<!-- Filename: templates/email/edit.html -->
<!-- Copyright 2025 SILICONDEV SPA -->
<!-- Description: Edit existing email template -->

{% extends "base.html" %}

{% block title %}Modifica Template - {{ super() }}{% endblock %}

{% block extra_head %}
<!-- TinyMCE Editor -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-pencil-square me-2"></i>
            Modifica Template
        </h1>
        <div class="btn-group">
            <a href="{{ url_for('email.templates') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                Indietro
            </a>
            <button type="button" class="btn btn-info" id="previewBtn">
                <i class="bi bi-eye me-1"></i>
                Anteprima
            </button>
        </div>
    </div>

    <!-- Template Info -->
    {% if template_info %}
    <div class="alert alert-info" role="alert">
        <h6><i class="bi bi-info-circle me-2"></i>Template: {{ template_info.name }}</h6>
        <div class="row">
            <div class="col-md-6">
                <small><strong>File:</strong> {{ template_info.filename }}</small>
            </div>
            <div class="col-md-6">
                <small><strong>Ultima modifica:</strong> {{ template_info.modified|datetime if template_info.modified else 'N/A' }}</small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Edit Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="POST" id="editTemplateForm">
                        <!-- Template Name -->
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="templateName" class="form-label">
                                    <i class="bi bi-tag me-1"></i>
                                    Nome Template *
                                </label>
                                <input type="text" class="form-control" id="templateName" name="template_name"
                                       value="{{ template_data.name if template_data else '' }}" required>
                                <small class="form-text text-muted">
                                    Nome identificativo del template (solo lettere, numeri e underscore)
                                </small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="templateCategory" class="form-label">
                                    <i class="bi bi-collection me-1"></i>
                                    Categoria
                                </label>
                                <select class="form-select" id="templateCategory" name="category">
                                    <option value="general" {{ 'selected' if template_data and template_data.category == 'general' else '' }}>Generale</option>
                                    <option value="welcome" {{ 'selected' if template_data and template_data.category == 'welcome' else '' }}>Benvenuto</option>
                                    <option value="auction" {{ 'selected' if template_data and template_data.category == 'auction' else '' }}>Aste</option>
                                    <option value="notification" {{ 'selected' if template_data and template_data.category == 'notification' else '' }}>Notifiche</option>
                                    <option value="newsletter" {{ 'selected' if template_data and template_data.category == 'newsletter' else '' }}>Newsletter</option>
                                </select>
                            </div>
                        </div>

                        <!-- Subject -->
                        <div class="mb-3">
                            <label for="templateSubject" class="form-label">
                                <i class="bi bi-chat-quote me-1"></i>
                                Oggetto di Default
                            </label>
                            <input type="text" class="form-control" id="templateSubject" name="default_subject"
                                   value="{{ template_data.subject if template_data else '' }}"
                                   placeholder="Oggetto email per questo template">
                            <small class="form-text text-muted">
                                Oggetto suggerito quando si usa questo template
                            </small>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="templateDescription" class="form-label">
                                <i class="bi bi-card-text me-1"></i>
                                Descrizione
                            </label>
                            <textarea class="form-control" id="templateDescription" name="description" rows="2"
                                      placeholder="Breve descrizione dell'uso del template">{{ template_data.description if template_data else '' }}</textarea>
                        </div>

                        <!-- Variables Help -->
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-code-slash me-2"></i>
                                    Variabili Disponibili
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Utente:</h6>
                                        <ul class="small mb-0">
                                            <li><code>{{ "{{ user_name }}" }}</code> - Nome completo</li>
                                            <li><code>{{ "{{ user_email }}" }}</code> - Email utente</li>
                                            <li><code>{{ "{{ user_first_name }}" }}</code> - Nome</li>
                                            <li><code>{{ "{{ user_last_name }}" }}</code> - Cognome</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Sistema:</h6>
                                        <ul class="small mb-0">
                                            <li><code>{{ "{{ current_year }}" }}</code> - Anno corrente</li>
                                            <li><code>{{ "{{ site_url }}" }}</code> - URL del sito</li>
                                            <li><code>{{ "{{ login_url }}" }}</code> - URL login</li>
                                            <li><code>{{ "{{ support_email }}" }}</code> - Email supporto</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <h6>Propriet√†/Aste:</h6>
                                        <ul class="small mb-0">
                                            <li><code>{{ "{{ property_address }}" }}</code> - Indirizzo</li>
                                            <li><code>{{ "{{ property_type }}" }}</code> - Tipo immobile</li>
                                            <li><code>{{ "{{ auction_url }}" }}</code> - Link asta</li>
                                            <li><code>{{ "{{ current_bid }}" }}</code> - Offerta attuale</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Date:</h6>
                                        <ul class="small mb-0">
                                            <li><code>{{ "{{ registration_date }}" }}</code> - Data registrazione</li>
                                            <li><code>{{ "{{ auction_end_date }}" }}</code> - Fine asta</li>
                                            <li><code>{{ "{{ today_date }}" }}</code> - Data odierna</li>
                                            <li><code>{{ "{{ month_year }}" }}</code> - Mese Anno</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- HTML Content Editor -->
                        <div class="mb-3">
                            <label for="templateContent" class="form-label">
                                <i class="bi bi-code-square me-1"></i>
                                Contenuto HTML *
                            </label>
                            <textarea class="form-control" id="templateContent" name="html_content" rows="20" required>{{ template_data.content if template_data else '' }}</textarea>
                            <small class="form-text text-muted">
                                Usa HTML per formattare il contenuto. Le variabili verranno sostituite automaticamente.
                            </small>
                        </div>

                        <!-- Settings -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active"
                                           {{ 'checked' if template_data and template_data.is_active else 'checked' }}>
                                    <label class="form-check-label" for="isActive">
                                        Template attivo
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Solo i template attivi sono visibili nell'elenco
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="allowUserSend" name="allow_user_send"
                                           {{ 'checked' if template_data and template_data.allow_user_send else '' }}>
                                    <label class="form-check-label" for="allowUserSend">
                                        Consentire agli utenti di usare questo template
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Se disabilitato, solo gli admin possono usarlo
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="card bg-light mb-3" id="previewSection" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-eye me-2"></i>
                                    Anteprima Template
                                </h6>
                            </div>
                            <div class="card-body" id="previewContent" style="max-height: 400px; overflow-y: auto;">
                                <!-- Preview content will be loaded here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-info" id="previewBtnBottom">
                                    <i class="bi bi-eye me-1"></i>
                                    Anteprima
                                </button>
                                <button type="button" class="btn btn-warning" id="testSendBtn">
                                    <i class="bi bi-send me-1"></i>
                                    Test Invio
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="history.back()">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Annulla
                                </button>
                                <button type="submit" class="btn btn-success" id="saveBtn">
                                    <i class="bi bi-save me-1"></i>
                                    Salva Template
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Send Modal -->
<div class="modal fade" id="testSendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-send me-2"></i>
                    Test Invio Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testSendForm">
                    <div class="mb-3">
                        <label for="testEmail" class="form-label">Email di Test</label>
                        <input type="email" class="form-control" id="testEmail"
                               value="{{ current_user.email }}" required>
                        <small class="form-text text-muted">
                            L'email di test verr√† inviata a questo indirizzo
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="testSubject" class="form-label">Oggetto Test</label>
                        <input type="text" class="form-control" id="testSubject"
                               value="[TEST] {{ template_data.name if template_data else 'Template' }}">
                    </div>

                    <!-- Mock Variables -->
                    <div class="mb-3">
                        <label class="form-label">Variabili Test</label>
                        <div class="bg-light p-3 rounded">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small">user_name</label>
                                    <input type="text" class="form-control form-control-sm"
                                           name="test_user_name" value="{{ current_user.full_name }}">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small">user_email</label>
                                    <input type="text" class="form-control form-control-sm"
                                           name="test_user_email" value="{{ current_user.email }}">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small">property_address</label>
                                    <input type="text" class="form-control form-control-sm"
                                           name="test_property_address" value="Via Roma 123, Milano">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small">current_bid</label>
                                    <input type="text" class="form-control form-control-sm"
                                           name="test_current_bid" value="250,000">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="sendTestEmailBtn">
                    <i class="bi bi-send me-1"></i>
                    Invia Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview functionality
    const previewBtns = document.querySelectorAll('#previewBtn, #previewBtnBottom');
    previewBtns.forEach(btn => {
        btn.addEventListener('click', showPreview);
    });

    // Test send functionality
    document.getElementById('testSendBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('testSendModal'));
        modal.show();
    });

    // Form submission
    document.getElementById('editTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTemplate();
    });

    // Send test email
    document.getElementById('sendTestEmailBtn').addEventListener('click', sendTestEmail);

    // Auto-save draft
    let autoSaveTimer;
    const formInputs = document.querySelectorAll('#editTemplateForm input, #editTemplateForm textarea, #editTemplateForm select');
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveDraft, 3000);
        });
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    saveTemplate();
                    break;
                case 'p':
                    e.preventDefault();
                    showPreview();
                    break;
            }
        }
    });

    // Textarea enhancements
    const textarea = document.getElementById('templateContent');
    textarea.addEventListener('keydown', function(e) {
        // Tab key inserts 2 spaces
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 2;
        }

        // Ctrl+/ for comment toggle
        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
            e.preventDefault();
            toggleComment();
        }
    });

    // Line numbers (optional)
    addLineNumbers();
});

// HTML Tag insertion functions
function insertTag(tag) {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    let insertion;
    switch(tag) {
        case 'ul':
            insertion = `<ul>\n  <li>Elemento lista</li>\n  <li>Altro elemento</li>\n</ul>`;
            break;
        case 'ol':
            insertion = `<ol>\n  <li>Primo elemento</li>\n  <li>Secondo elemento</li>\n</ol>`;
            break;
        case 'table':
            insertion = `<table style="width: 100%; border-collapse: collapse;">
  <tr>
    <th style="border: 1px solid #ddd; padding: 8px;">Intestazione 1</th>
    <th style="border: 1px solid #ddd; padding: 8px;">Intestazione 2</th>
  </tr>
  <tr>
    <td style="border: 1px solid #ddd; padding: 8px;">Cella 1</td>
    <td style="border: 1px solid #ddd; padding: 8px;">Cella 2</td>
  </tr>
</table>`;
            break;
        default:
            if (selectedText) {
                insertion = `<${tag}>${selectedText}</${tag}>`;
            } else {
                insertion = `<${tag}>Testo qui</${tag}>`;
            }
    }

    textarea.value = textarea.value.substring(0, start) + insertion + textarea.value.substring(end);

    // Position cursor
    const newPos = start + insertion.length;
    textarea.focus();
    textarea.setSelectionRange(newPos, newPos);

    // Trigger auto-save
    textarea.dispatchEvent(new Event('input'));
}

function insertLink() {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    const url = prompt('Inserisci URL:', 'https://');
    if (url) {
        const linkText = selectedText || 'Testo del link';
        const insertion = `<a href="${url}" style="color: #007bff; text-decoration: none;">${linkText}</a>`;

        textarea.value = textarea.value.substring(0, start) + insertion + textarea.value.substring(end);
        textarea.focus();

        // Trigger auto-save
        textarea.dispatchEvent(new Event('input'));
    }
}

function insertTable() {
    const rows = prompt('Numero di righe:', '2');
    const cols = prompt('Numero di colonne:', '2');

    if (rows && cols) {
        let table = '<table style="width: 100%; border-collapse: collapse;">\n';

        // Header
        table += '  <tr>\n';
        for (let i = 1; i <= cols; i++) {
            table += `    <th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">Intestazione ${i}</th>\n`;
        }
        table += '  </tr>\n';

        // Rows
        for (let r = 1; r < rows; r++) {
            table += '  <tr>\n';
            for (let c = 1; c <= cols; c++) {
                table += `    <td style="border: 1px solid #ddd; padding: 8px;">Cella ${r}-${c}</td>\n`;
            }
            table += '  </tr>\n';
        }

        table += '</table>';

        const textarea = document.getElementById('templateContent');
        const start = textarea.selectionStart;
        textarea.value = textarea.value.substring(0, start) + table + textarea.value.substring(start);
        textarea.focus();

        // Trigger auto-save
        textarea.dispatchEvent(new Event('input'));
    }
}

function insertDiv() {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    const className = prompt('Classe CSS (opzionale):', '');
    const style = prompt('Stile inline (opzionale):', 'padding: 15px; margin: 10px 0;');

    let divTag = '<div';
    if (className) divTag += ` class="${className}"`;
    if (style) divTag += ` style="${style}"`;
    divTag += '>';

    const insertion = `${divTag}\n  ${selectedText || 'Contenuto div'}\n</div>`;

    textarea.value = textarea.value.substring(0, start) + insertion + textarea.value.substring(end);
    textarea.focus();

    // Trigger auto-save
    textarea.dispatchEvent(new Event('input'));
}

function insertVariable() {
    const variables = [
        { name: 'user_name', desc: 'Nome completo utente' },
        { name: 'user_email', desc: 'Email utente' },
        { name: 'user_first_name', desc: 'Nome utente' },
        { name: 'user_last_name', desc: 'Cognome utente' },
        { name: 'current_year', desc: 'Anno corrente' },
        { name: 'site_url', desc: 'URL del sito' },
        { name: 'login_url', desc: 'URL login' },
        { name: 'property_address', desc: 'Indirizzo propriet√†' },
        { name: 'property_type', desc: 'Tipo propriet√†' },
        { name: 'auction_url', desc: 'Link asta' },
        { name: 'current_bid', desc: 'Offerta attuale' },
        { name: 'today_date', desc: 'Data odierna' }
    ];

    let options = 'Seleziona variabile:\n';
    variables.forEach((v, i) => {
        options += `${i + 1}. ${v.name} - ${v.desc}\n`;
    });

    const choice = prompt(options + '\nInserisci numero:');
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < variables.length) {
        const textarea = document.getElementById('templateContent');
        const start = textarea.selectionStart;
        const variable = `{{ ${variables[index].name} }}`;

        textarea.value = textarea.value.substring(0, start) + variable + textarea.value.substring(start);
        textarea.focus();
        textarea.setSelectionRange(start + variable.length, start + variable.length);

        // Trigger auto-save
        textarea.dispatchEvent(new Event('input'));
    }
}

function toggleComment() {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    let insertion;
    if (selectedText.includes('<!--') && selectedText.includes('-->')) {
        // Uncomment
        insertion = selectedText.replace(/<!--\s*/, '').replace(/\s*-->/, '');
    } else {
        // Comment
        insertion = `<!-- ${selectedText || 'Commento'} -->`;
    }

    textarea.value = textarea.value.substring(0, start) + insertion + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start, start + insertion.length);

    // Trigger auto-save
    textarea.dispatchEvent(new Event('input'));
}

function addLineNumbers() {
    const textarea = document.getElementById('templateContent');
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.fontFamily = 'monospace';

    const lineNumbers = document.createElement('div');
    lineNumbers.style.position = 'absolute';
    lineNumbers.style.left = '0';
    lineNumbers.style.top = '0';
    lineNumbers.style.width = '40px';
    lineNumbers.style.background = '#f8f9fa';
    lineNumbers.style.border = '1px solid #dee2e6';
    lineNumbers.style.borderRight = '2px solid #007bff';
    lineNumbers.style.color = '#6c757d';
    lineNumbers.style.fontSize = '14px';
    lineNumbers.style.lineHeight = '1.5';
    lineNumbers.style.padding = '8px 4px';
    lineNumbers.style.textAlign = 'right';
    lineNumbers.style.userSelect = 'none';
    lineNumbers.style.pointerEvents = 'none';

    textarea.style.paddingLeft = '50px';

    function updateLineNumbers() {
        const lines = textarea.value.split('\n').length;
        var numbers = '';
        for (var i = 1; i <= lines; i++) {
            numbers += i + '\n';
        }
        lineNumbers.textContent = numbers;
        lineNumbers.style.height = textarea.scrollHeight + 'px';
    }

    textarea.addEventListener('input', updateLineNumbers);
    textarea.addEventListener('scroll', function() {
        lineNumbers.scrollTop = textarea.scrollTop;
    });

    // Initial setup
    textarea.parentNode.insertBefore(wrapper, textarea);
    wrapper.appendChild(lineNumbers);
    wrapper.appendChild(textarea);
    updateLineNumbers();
}

function showPreview() {
    const templateName = document.getElementById('templateName').value;
    const templateSubject = document.getElementById('templateSubject').value;
    const templateContent = document.getElementById('templateContent').value;

    if (!templateContent.trim()) {
        showAlert('Inserisci il contenuto del template per vedere l\'anteprima', 'warning');
        return;
    }

    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');

    // Mock variables for preview
    let previewHTML = templateContent
        .replace(/\{\{\s*user_name\s*\}\}/g, '{{ current_user.full_name }}')
        .replace(/\{\{\s*user_email\s*\}\}/g, '{{ current_user.email }}')
        .replace(/\{\{\s*user_first_name\s*\}\}/g, '{{ current_user.first_name }}')
        .replace(/\{\{\s*user_last_name\s*\}\}/g, '{{ current_user.last_name }}')
        .replace(/\{\{\s*current_year\s*\}\}/g, '2025')
        .replace(/\{\{\s*site_url\s*\}\}/g, window.location.origin)
        .replace(/\{\{\s*property_address\s*\}\}/g, 'Via Roma 123, Milano')
        .replace(/\{\{\s*property_type\s*\}\}/g, 'Appartamento')
        .replace(/\{\{\s*current_bid\s*\}\}/g, '250,000')
        .replace(/\{\{\s*today_date\s*\}\}/g, new Date().toLocaleDateString('it-IT'));

    const preview = `
        <div class="email-preview">
            <div class="email-header mb-3 pb-2 border-bottom">
                <div><strong>Template:</strong> ${templateName || 'Senza nome'}</div>
                <div><strong>Oggetto:</strong> ${templateSubject || 'Nessun oggetto'}</div>
            </div>
            <div class="email-content">
                ${previewHTML}
            </div>
        </div>
    `;

    previewContent.innerHTML = preview;
    previewSection.style.display = 'block';
    previewSection.scrollIntoView({ behavior: 'smooth' });
}

function saveTemplate() {
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;

    // Show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';

    // Get form data
    const formData = new FormData(document.getElementById('editTemplateForm'));

    // Simulate save (replace with actual API call)
    setTimeout(() => {
        // Success simulation
        showAlert('Template salvato con successo!', 'success');

        // Clear draft
        localStorage.removeItem('template_draft_{{ template_data.id if template_data else "new" }}');

        // Redirect to templates list after delay
        setTimeout(() => {
            window.location.href = "{{ url_for('email.templates') }}";
        }, 1500);

    }, 2000);
}

function sendTestEmail() {
    const sendBtn = document.getElementById('sendTestEmailBtn');
    const originalText = sendBtn.innerHTML;

    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Invio...';

    // Get test data
    const testEmail = document.getElementById('testEmail').value;
    const testSubject = document.getElementById('testSubject').value;

    // Get mock variables
    const testVars = {};
    document.querySelectorAll('#testSendForm [name^="test_"]').forEach(input => {
        const varName = input.name.replace('test_', '');
        testVars[varName] = input.value;
    });

    const templateContent = document.getElementById('templateContent').value;

    // Simulate send
    setTimeout(() => {
        showAlert('Email di test inviata con successo!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('testSendModal')).hide();

        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }, 2000);
}

function saveDraft() {
    try {
        const draftData = {
            name: document.getElementById('templateName').value,
            subject: document.getElementById('templateSubject').value,
            description: document.getElementById('templateDescription').value,
            content: document.getElementById('templateContent').value,
            category: document.getElementById('templateCategory').value,
            is_active: document.getElementById('isActive').checked,
            allow_user_send: document.getElementById('allowUserSend').checked,
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('template_draft_{{ template_data.id if template_data else "new" }}', JSON.stringify(draftData));
        console.log('Draft saved');
    } catch (e) {
        console.warn('Could not save draft');
    }
}

function loadDraft() {
    try {
        const draftKey = 'template_draft_{{ template_data.id if template_data else "new" }}';
        const draft = JSON.parse(localStorage.getItem(draftKey));

        if (draft && draft.timestamp) {
            const timeDiff = new Date() - new Date(draft.timestamp);
            if (timeDiff < 24 * 60 * 60 * 1000) { // 24 hours
                if (confirm('√à stata trovata una bozza salvata. Vuoi ripristinarla?')) {
                    // Load draft data
                    document.getElementById('templateName').value = draft.name || '';
                    document.getElementById('templateSubject').value = draft.subject || '';
                    document.getElementById('templateDescription').value = draft.description || '';
                    document.getElementById('templateCategory').value = draft.category || 'general';
                    document.getElementById('isActive').checked = draft.is_active !== false;
                    document.getElementById('allowUserSend').checked = draft.allow_user_send || false;
                    document.getElementById('templateContent').value = draft.content || '';
                }
            }
        }
    } catch (e) {
        console.warn('Could not load draft');
    }
}

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    // Auto-dismiss
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        if (alerts.length > 0) {
            alerts[alerts.length - 1].remove();
        }
    }, 5000);
}

// Load draft on page load
window.addEventListener('load', loadDraft);
</script>
{% endblock %}