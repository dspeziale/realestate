<!-- templates/vehicles/live_tracking.html -->
{% extends "base.html" %}

{% block title %}Live Tracking - {{ vehicle.name }}{% endblock %}

{% block content %}
<!-- Header info bar -->
<div class="bg-white p-4 flex items-center justify-between shadow-md border-b">
    <div class="flex items-center space-x-4">
        <a href="{{ url_for('vehicles.detail', vehicle_id=vehicle.id) }}"
           class="text-gray-600 hover:text-gray-800 font-medium">
            ← Back
        </a>
        <div>
            <h2 class="text-xl font-bold text-gray-800">{{ vehicle.name }}</h2>
            <p class="text-gray-600 text-sm">Live Tracking</p>
        </div>
    </div>

    <div class="flex items-center space-x-4">
        <div class="text-center">
            <p class="text-gray-600 text-xs">Speed</p>
            <p class="text-gray-800 font-bold" id="currentSpeed">-- km/h</p>
        </div>
        <div class="text-center">
            <p class="text-gray-600 text-xs">Status</p>
            <p class="font-bold text-green-600" id="connectionStatus">{{ vehicle.status|capitalize }}</p>
        </div>
        <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 border border-green-200 rounded-lg">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" id="liveIndicator"></div>
            <span class="text-sm text-green-700 font-medium">Live</span>
        </div>
    </div>
</div>

<!-- Map Container - FIXED HEIGHT -->
<div style="height: calc(100vh - 200px);" class="relative">
    <div id="map" class="w-full h-full"></div>

    <!-- Map Controls -->
    <div class="absolute top-4 right-4 space-y-2 z-[1000]">
        <button onclick="centerOnVehicle()"
                class="bg-white border border-gray-300 p-3 rounded-lg hover:bg-gray-50 transition shadow-md"
                title="Center on vehicle">
            <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            </svg>
        </button>

        <button onclick="toggleAutoFollow()" id="autoFollowBtn"
                class="bg-white border border-gray-300 p-3 rounded-lg hover:bg-gray-50 transition shadow-md bg-blue-100 border-blue-300"
                title="Toggle auto-follow">
            <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
        </button>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-[1000]">
        <p class="font-semibold">Connection Error</p>
        <p class="text-sm">Unable to fetch vehicle position</p>
    </div>
</div>

<script>
const vehicleId = {{ vehicle.id }};
let map, vehicleMarker, routeLine;
let autoFollow = true;
let routeCoords = [];
let updateInterval;
let errorCount = 0;
const MAX_ERRORS = 3;

// Initialize map
function initMap() {
    map = L.map('map', { zoomControl: false }).setView([41.9, 12.5], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap, © CartoDB',
        maxZoom: 19
    }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Force map to recalculate size
    setTimeout(() => map.invalidateSize(), 100);
}

// Setup initial route
function setupRoute() {
    const initialPositions = {{ positions|tojson|safe }};

    console.log('Initial positions:', initialPositions);

    if (initialPositions && initialPositions.length > 0) {
        initialPositions.forEach(pos => {
            if (pos.latitude && pos.longitude) {
                routeCoords.push([pos.latitude, pos.longitude]);
            }
        });

        if (routeCoords.length > 0) {
            routeLine = L.polyline(routeCoords, {
                color: '#3b82f6',
                weight: 3,
                opacity: 0.6
            }).addTo(map);

            const lastPos = routeCoords[routeCoords.length - 1];
            createVehicleMarker(lastPos);
            map.setView(lastPos, 13);
        }
    }
}

// Create vehicle marker
function createVehicleMarker(position) {
    if (vehicleMarker) {
        vehicleMarker.setLatLng(position);
        return;
    }

    vehicleMarker = L.marker(position, {
        icon: L.divIcon({
            html: `
                <div class="relative">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center shadow-lg border-2 border-white">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                        </svg>
                    </div>
                    <div class="absolute top-0 left-0 w-10 h-10 bg-blue-600 rounded-full animate-ping opacity-75"></div>
                </div>
            `,
            className: '',
            iconSize: [40, 40]
        })
    }).addTo(map);
}

// Update vehicle position
function updatePosition() {
    fetch(`/api/vehicles/${vehicleId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(vehicle => {
            errorCount = 0;
            hideError();

            if (vehicle.latitude && vehicle.longitude) {
                const newPos = [vehicle.latitude, vehicle.longitude];

                if (vehicleMarker) {
                    vehicleMarker.setLatLng(newPos);
                } else {
                    createVehicleMarker(newPos);
                }

                // Update route
                routeCoords.push(newPos);
                if (routeCoords.length > 100) routeCoords.shift();

                if (routeLine) {
                    routeLine.setLatLngs(routeCoords);
                } else {
                    routeLine = L.polyline([newPos], {
                        color: '#3b82f6',
                        weight: 3,
                        opacity: 0.6
                    }).addTo(map);
                }

                // Auto-follow
                if (autoFollow) {
                    map.panTo(newPos, {
                        animate: true,
                        duration: 0.5
                    });
                }

                // Update UI
                const speed = vehicle.speed || 0;
                document.getElementById('currentSpeed').textContent = `${Math.round(speed)} km/h`;

                const status = vehicle.status === 'online' ? 'Connected' : 'Offline';
                const color = vehicle.status === 'online' ? 'green' : 'orange';
                updateConnectionStatus(status, color);
            }
        })
        .catch(err => {
            console.error('Update error:', err);
            errorCount++;

            if (errorCount >= MAX_ERRORS) {
                showError();
                updateConnectionStatus('Error', 'red');
            }
        });
}

function updateConnectionStatus(status, color) {
    const statusEl = document.getElementById('connectionStatus');
    const indicator = document.getElementById('liveIndicator');

    if (statusEl) {
        statusEl.textContent = status;
        statusEl.className = `font-bold text-${color}-600`;
    }

    if (indicator) {
        indicator.className = `w-2 h-2 bg-${color}-500 rounded-full ${color === 'green' ? 'animate-pulse' : ''}`;
    }
}

function showError() {
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) errorEl.classList.remove('hidden');
}

function hideError() {
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) errorEl.classList.add('hidden');
}

function centerOnVehicle() {
    if (vehicleMarker) {
        map.setView(vehicleMarker.getLatLng(), 13);
    }
}

function toggleAutoFollow() {
    autoFollow = !autoFollow;
    const btn = document.getElementById('autoFollowBtn');

    if (btn) {
        if (autoFollow) {
            btn.classList.add('bg-blue-100', 'border-blue-300');
            if (vehicleMarker) {
                map.setView(vehicleMarker.getLatLng(), map.getZoom());
            }
        } else {
            btn.classList.remove('bg-blue-100', 'border-blue-300');
        }
    }
}

// Initialize when ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

function init() {
    console.log('Initializing live tracking for vehicle:', vehicleId);

    initMap();
    setupRoute();

    // Start polling
    updatePosition();
    updateInterval = setInterval(updatePosition, 5000);
}

// Cleanup
window.addEventListener('beforeunload', () => {
    if (updateInterval) clearInterval(updateInterval);
});
</script>
{% endblock %}