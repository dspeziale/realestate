<!-- templates/vehicles/history.html -->
{% extends "base.html" %}

{% block title %}Storico {{ vehicle.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #historyMap { height: 400px; }
    .trip-card { transition: all 0.2s ease; }
    .trip-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .metric-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('vehicles.detail', vehicle_id=vehicle.id) }}"
               class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">üìä Storico {{ vehicle.name }}</h1>
                <p class="text-gray-600">{{ vehicle.uniqueId or vehicle.id }} ‚Ä¢ Ultimi {{ days }} giorni</p>
            </div>
        </div>

        <!-- Period Selector -->
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">Periodo:</span>
            {% for d in [1, 3, 7, 15, 30] %}
            <a href="{{ url_for('vehicles.history', vehicle_id=vehicle.id, days=d) }}"
               class="px-3 py-1 text-sm rounded-lg transition-colors
                      {% if days == d %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                {{ d }}{{ 'g' if d == 1 else ' gg' }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Summary Stats -->
    {% if summary %}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="metric-card rounded-xl p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Distanza Totale</p>
                    <p class="text-2xl font-bold text-blue-600">{{ (summary.distance / 1000)|round(1) }} km</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="metric-card rounded-xl p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Tempo Totale</p>
                    <p class="text-2xl font-bold text-green-600">{{ (summary.engineHours / 3600)|round(1) }}h</p>
                </div>
                <div class="p-3 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="metric-card rounded-xl p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Velocit√† Media</p>
                    <p class="text-2xl font-bold text-purple-600">{{ summary.averageSpeed|round(1) }} km/h</p>
                </div>
                <div class="p-3 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="metric-card rounded-xl p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Velocit√† Max</p>
                    <p class="text-2xl font-bold text-red-600">{{ summary.maxSpeed|round(1) }} km/h</p>
                </div>
                <div class="p-3 bg-red-100 rounded-lg">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Map Column -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">üó∫Ô∏è Percorso Storico</h3>
                    <p class="text-sm text-gray-600">{{ positions|length }} posizioni registrate</p>
                </div>
                <div id="historyMap"></div>
            </div>

            <!-- Trips Section -->
            {% if trips %}
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">üöó Viaggi Recenti</h3>
                    <p class="text-sm text-gray-600">{{ trips|length }} viaggi trovati</p>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for trip in trips[:10] %}
                        <div class="trip-card bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4 mb-2">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                            {{ (trip.distance / 1000)|round(2) }} km
                                        </span>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                                            {{ (trip.duration / 60)|round(0) }} min
                                        </span>
                                        <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">
                                            {{ trip.averageSpeed|round(1) }} km/h
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-1">
                                        üïê {{ trip.startTime|datetime('%d/%m/%Y %H:%M') }}
                                        ‚Üí {{ trip.endTime|datetime('%H:%M') }}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        üìç {{ trip.startAddress or 'Posizione sconosciuta' }}
                                    </p>
                                </div>
                                <button onclick="showTripOnMap({{ loop.index0 }})"
                                        class="px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-colors">
                                    Mostra
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Sidebar -->
        <div class="space-y-6">
            <!-- Vehicle Info -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">üöô Informazioni Veicolo</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Nome:</span>
                            <span class="text-sm font-medium text-gray-900">{{ vehicle.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">ID Univoco:</span>
                            <span class="text-sm font-medium text-gray-900">{{ vehicle.uniqueId or 'N/A' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Categoria:</span>
                            <span class="text-sm font-medium text-gray-900">{{ vehicle.category or 'Non specificata' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Stato:</span>
                            <span class="text-sm font-medium {{ 'text-green-600' if vehicle.status == 'online' else 'text-red-600' }}">
                                {{ 'üü¢ Online' if vehicle.status == 'online' else 'üî¥ Offline' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stops Section -->
            {% if stops %}
            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">‚è∏Ô∏è Soste</h3>
                    <p class="text-sm text-gray-600">{{ stops|length }} soste registrate</p>
                </div>
                <div class="p-6">
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for stop in stops[:10] %}
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium text-gray-900">{{ (stop.duration / 60)|round(0) }} min</span>
                                <span class="text-xs text-gray-500">{{ stop.startTime|datetime('%d/%m %H:%M') }}</span>
                            </div>
                            <p class="text-xs text-gray-600">{{ stop.address or 'Posizione sconosciuta' }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">‚ö° Azioni</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <a href="{{ url_for('vehicles.live_tracking', vehicle_id=vehicle.id) }}"
                           class="w-full inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                            üìç Tracking Live
                        </a>
                        <a href="{{ url_for('vehicles.detail', vehicle_id=vehicle.id) }}"
                           class="w-full inline-flex items-center justify-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors">
                            ‚ÑπÔ∏è Dettagli Completi
                        </a>
                        <button onclick="exportData()"
                                class="w-full inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                            üìä Esporta Dati
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize map
const map = L.map('historyMap').setView([41.9, 12.5], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Load positions data
const positions = {{ positions|tojson|safe }};
const trips = {{ trips|tojson|safe }};

let currentTrack = null;
let markers = [];

// Function to display all positions
function showAllPositions() {
    clearMap();

    if (positions.length === 0) {
        alert('Nessuna posizione disponibile per il periodo selezionato');
        return;
    }

    // Create track
    const coords = positions.map(p => [p.latitude, p.longitude]);
    currentTrack = L.polyline(coords, {
        color: '#3b82f6',
        weight: 3,
        opacity: 0.8
    }).addTo(map);

    // Start marker (green)
    if (coords.length > 0) {
        markers.push(L.circleMarker(coords[0], {
            radius: 8,
            fillColor: '#10b981',
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map).bindPopup('üöÄ Inizio periodo'));

        // End marker (red)
        markers.push(L.circleMarker(coords[coords.length - 1], {
            radius: 8,
            fillColor: '#ef4444',
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map).bindPopup('üèÅ Fine periodo'));

        // Fit bounds
        map.fitBounds(currentTrack.getBounds(), { padding: [20, 20] });
    }
}

// Function to show specific trip
function showTripOnMap(tripIndex) {
    clearMap();

    if (!trips[tripIndex]) return;

    const trip = trips[tripIndex];

    // Filter positions for this trip
    const tripStart = new Date(trip.startTime);
    const tripEnd = new Date(trip.endTime);

    const tripPositions = positions.filter(p => {
        const posTime = new Date(p.deviceTime || p.serverTime);
        return posTime >= tripStart && posTime <= tripEnd;
    });

    if (tripPositions.length === 0) {
        alert('Nessuna posizione trovata per questo viaggio');
        return;
    }

    // Create trip track
    const coords = tripPositions.map(p => [p.latitude, p.longitude]);
    currentTrack = L.polyline(coords, {
        color: '#f59e0b',
        weight: 4,
        opacity: 0.9
    }).addTo(map);

    // Trip markers
    markers.push(L.circleMarker(coords[0], {
        radius: 10,
        fillColor: '#10b981',
        color: '#fff',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.9
    }).addTo(map).bindPopup(`üöÄ Inizio Viaggio<br>${formatDateTime(trip.startTime)}`));

    markers.push(L.circleMarker(coords[coords.length - 1], {
        radius: 10,
        fillColor: '#ef4444',
        color: '#fff',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.9
    }).addTo(map).bindPopup(`üèÅ Fine Viaggio<br>${formatDateTime(trip.endTime)}`));

    // Fit bounds
    map.fitBounds(currentTrack.getBounds(), { padding: [30, 30] });
}

// Function to clear map
function clearMap() {
    if (currentTrack) {
        map.removeLayer(currentTrack);
        currentTrack = null;
    }
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
}

// Function to export data
function exportData() {
    const url = `/api/vehicles/{{ vehicle.id }}/export?days={{ days }}`;
    window.open(url, '_blank');
}

// Helper function to format dates
function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('it-IT');
    } catch (e) {
        return dateString;
    }
}

// Initialize with all positions
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(showAllPositions, 500);
});
</script>
{% endblock %}