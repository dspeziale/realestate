{% extends "base.html" %}

{% block title %}Errore Interno{% endblock %}
{% block page_title %}Errore 500{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li class="breadcrumb-item active">Errore 500</li>
{% endblock %}

{% block content %}
<div class="error-page">
    <h2 class="headline text-danger">500</h2>

    <div class="error-content">
        <h3><i class="fas fa-exclamation-triangle text-danger"></i> Oops! Qualcosa è andato storto.</h3>

        <p>
            Si è verificato un errore interno del server.
            Il nostro team tecnico è già stato informato.
            Puoi provare a:
        </p>

        <div class="row">
            <div class="col-md-6">
                <div class="card card-danger card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-redo"></i>
                            Riprova
                        </h3>
                    </div>
                    <div class="card-body">
                        <p>A volte si tratta di un problema temporaneo.</p>
                        <button onclick="window.location.reload()" class="btn btn-warning">
                            <i class="fas fa-sync-alt"></i> Ricarica Pagina
                        </button>
                        <button onclick="history.back()" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left"></i> Indietro
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card card-info card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-home"></i>
                            Torna al Sicuro
                        </h3>
                    </div>
                    <div class="card-body">
                        <p>Torna alla pagina principale e riprova da lì.</p>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                        <a href="{{ url_for('logout') }}" class="btn btn-warning ml-2">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <h5><i class="fas fa-info-circle"></i> Informazioni Tecniche</h5>
            <p><strong>Codice Errore:</strong> 500 - Internal Server Error</p>
            <p><strong>Timestamp:</strong> {{ moment().format('DD/MM/YYYY HH:mm:ss') if moment else 'N/A' }}</p>
            <p class="mb-0">
                <strong>Cosa puoi fare:</strong>
                Se il problema persiste, contatta l'amministratore di sistema
                fornendo queste informazioni e la descrizione di cosa stavi facendo.
            </p>
        </div>

        {% if session.is_admin %}
        <div class="alert alert-warning">
            <h5><i class="fas fa-tools"></i> Informazioni per Amministratori</h5>
            <p>
                Come amministratore, puoi controllare i log del server per maggiori dettagli sull'errore.
                Verifica anche la connessione al server Traccar e lo stato dei servizi.
            </p>
            <div class="row">
                <div class="col-sm-6">
                    <strong>Server Traccar:</strong><br>
                    <code>{{ session.traccar_host }}:{{ session.traccar_port }}</code>
                </div>
                <div class="col-sm-6">
                    <strong>Utente:</strong><br>
                    <code>{{ session.traccar_username }}</code>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Auto-retry dopo 30 secondi (solo per errori 500)
    setTimeout(function() {
        if (confirm('Vuoi riprovare automaticamente a caricare la pagina?')) {
            window.location.reload();
        }
    }, 30000);

    // Log errore per tracking (se necessario)
    if (typeof TraccarFleet !== 'undefined' && TraccarFleet.getStorage) {
        const errorLog = TraccarFleet.getStorage('error_count', 3600000) || 0; // 1 ora
        TraccarFleet.setStorage('error_count', errorLog + 1, 3600000);
    }
});
</script>
{% endblock %}