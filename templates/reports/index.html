<!-- templates/reports/index.html - WITH PDF EXPORT -->
{% extends "base.html" %}

{% block content %}
<div class="min-h-screen p-6 bg-gray-50">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Fleet Reports</h2>
            <p class="text-gray-600 mt-1">Generate comprehensive reports for your fleet</p>
        </div>

        <!-- Report Configuration -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Configuration Panel -->
            <div class="lg:col-span-1 bg-white rounded-xl p-6 shadow-md border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Report Settings</h3>

                <!-- Report Type -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Report Type</label>
                    <select id="reportType" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-800">
                        <option value="summary">Summary Report</option>
                        <option value="trips">Trips Report</option>
                        <option value="stops">Stops Report</option>
                        <option value="route">Route Report</option>
                    </select>
                </div>

                <!-- Date Range -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Date Range</label>
                    <div class="space-y-2">
                        <input type="date" id="fromDate" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-800">
                        <input type="date" id="toDate" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-800">
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="setDateRange('today')" class="flex-1 text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Today</button>
                        <button onclick="setDateRange('week')" class="flex-1 text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Week</button>
                        <button onclick="setDateRange('month')" class="flex-1 text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Month</button>
                    </div>
                </div>

                <!-- Vehicle Selection -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Select Vehicles</label>
                    <div class="mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAll" onchange="toggleAllVehicles()" class="mr-2">
                            <span class="text-sm font-medium">Select All</span>
                        </label>
                    </div>
                    <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-2">
                        {% for vehicle in vehicles %}
                        <label class="flex items-center py-1 hover:bg-gray-50 px-2 rounded">
                            <input type="checkbox" value="{{ vehicle.id }}" class="vehicle-checkbox mr-2">
                            <span class="text-sm">{{ vehicle.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-2">
                    <button onclick="generateReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition">
                        Generate Report
                    </button>

                    <!-- Export Buttons -->
                    <div id="exportButtons" class="hidden space-y-2">
                        <button onclick="exportPDF()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                                <path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/>
                            </svg>
                            Export to PDF
                        </button>
                        <button onclick="exportCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                            </svg>
                            Export to CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Results -->
            <div class="lg:col-span-3 bg-white rounded-xl p-6 shadow-md border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Report Results</h3>
                    <div id="reportStats" class="text-gray-600 text-sm"></div>
                </div>

                <div id="reportResults" class="text-gray-600 text-center py-12">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="text-gray-600">Configure settings and click "Generate Report"</p>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                    <p class="text-gray-600 mt-4">Generating report...</p>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
let currentReportData = null;

const today = new Date();
const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

document.getElementById('toDate').valueAsDate = today;
document.getElementById('fromDate').valueAsDate = lastWeek;

function setDateRange(range) {
    const toDate = new Date();
    let fromDate = new Date();

    switch(range) {
        case 'today':
            fromDate = new Date(toDate);
            break;
        case 'week':
            fromDate = new Date(toDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'month':
            fromDate = new Date(toDate.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
    }

    document.getElementById('toDate').valueAsDate = toDate;
    document.getElementById('fromDate').valueAsDate = fromDate;
}

function toggleAllVehicles() {
    const selectAll = document.getElementById('selectAll').checked;
    document.querySelectorAll('.vehicle-checkbox').forEach(cb => {
        cb.checked = selectAll;
    });
}

async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const fromDate = document.getElementById('fromDate').value + 'T00:00:00';
    const toDate = document.getElementById('toDate').value + 'T23:59:59';

    const selectedVehicles = Array.from(document.querySelectorAll('.vehicle-checkbox:checked'))
        .map(cb => parseInt(cb.value));

    if (selectedVehicles.length === 0) {
        alert('Please select at least one vehicle');
        return;
    }

    document.getElementById('reportResults').classList.add('hidden');
    document.getElementById('loadingSpinner').classList.remove('hidden');
    document.getElementById('exportButtons').classList.add('hidden');

    try {
        const response = await fetch('/reports/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: reportType,
                device_ids: selectedVehicles,
                from: fromDate,
                to: toDate
            })
        });

        const result = await response.json();

        if (result.success) {
            currentReportData = result;
            displayReport(result);
            document.getElementById('exportButtons').classList.remove('hidden');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error generating report: ' + error);
    } finally {
        document.getElementById('loadingSpinner').classList.add('hidden');
    }
}

function displayReport(result) {
    const container = document.getElementById('reportResults');
    container.classList.remove('hidden');

    document.getElementById('reportStats').textContent = `${result.count} records found`;

    let html = '<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-300">';
    html += '<thead class="bg-gray-100"><tr>';

    if (result.report_type === 'summary') {
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Vehicle</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Distance</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Max Speed</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Avg Speed</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Engine Hours</th>';
    } else if (result.report_type === 'trips') {
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Vehicle</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Start Time</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">End Time</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Distance</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Duration</th>';
    } else if (result.report_type === 'stops') {
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Vehicle</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Start Time</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">End Time</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Duration</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Address</th>';
    } else if (result.report_type === 'route') {
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Vehicle</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Time</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Coordinates</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Speed</th>';
        html += '<th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Altitude</th>';
    }

    html += '</tr></thead><tbody>';

    result.data.forEach((item, index) => {
        html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;

        if (result.report_type === 'summary') {
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.deviceName}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.distance / 1000).toFixed(2)} km</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.maxSpeed * 1.852).toFixed(1)} km/h</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.averageSpeed * 1.852).toFixed(1)} km/h</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.engineHours || 0} h</td>`;
        } else if (result.report_type === 'trips') {
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.deviceName}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${new Date(item.startTime).toLocaleString()}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${new Date(item.endTime).toLocaleString()}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.distance / 1000).toFixed(2)} km</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.duration / 60).toFixed(0)} min</td>`;
        } else if (result.report_type === 'stops') {
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.deviceName}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${new Date(item.startTime).toLocaleString()}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${new Date(item.endTime).toLocaleString()}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.duration / 60000).toFixed(0)} min</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${item.address || 'N/A'}</td>`;
        } else if (result.report_type === 'route') {
            const time = new Date(item.deviceTime || item.serverTime).toLocaleString();
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.deviceName}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${time}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.latitude?.toFixed(6)}, ${item.longitude?.toFixed(6)}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${(item.speed * 1.852).toFixed(1)} km/h</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-800">${item.altitude?.toFixed(0)} m</td>`;
        }

        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function exportPDF() {
    if (!currentReportData) {
        alert('No report data to export');
        return;
    }

    try {
        const response = await fetch(`/reports/export/pdf/${currentReportData.report_type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                data: currentReportData.data,
                from_date: currentReportData.from_date,
                to_date: currentReportData.to_date
            })
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${currentReportData.report_type}_${new Date().toISOString().slice(0,10)}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        alert('Error exporting PDF: ' + error);
    }
}

async function exportCSV() {
    if (!currentReportData) {
        alert('No report data to export');
        return;
    }

    try {
        const response = await fetch(`/reports/export/csv/${currentReportData.report_type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                data: currentReportData.data
            })
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${currentReportData.report_type}_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        alert('Error exporting CSV: ' + error);
    }
}
</script>
{% endblock %}