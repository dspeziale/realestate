{% extends "base.html" %}

{% block title %}Riepilogo{% endblock %}
{% block page_title %}Report Riepilogativo{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li class="breadcrumb-item">Report</li>
<li class="breadcrumb-item active">Riepilogo</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Form Filtri -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-filter"></i>
                        Filtri Report
                    </h3>
                </div>
                <div class="card-body">
                    <form method="GET">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="deviceIds">Dispositivi:</label>
                                <select name="deviceIds" id="deviceIds" class="form-control" multiple>
                                    {% for device in devices %}
                                    <option value="{{ device.id }}"
                                        {{ 'selected' if device.id|string in selected_devices }}>
                                        {{ device.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="from">Da:</label>
                                <input type="datetime-local" name="from" id="from"
                                       class="form-control" value="{{ from }}">
                            </div>
                            <div class="col-md-3">
                                <label for="to">A:</label>
                                <input type="datetime-local" name="to" id="to"
                                       class="form-control" value="{{ to }}">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-search"></i> Genera
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if summary_data %}
    <div class="row">
        <div class="col-12">
            <!-- Tabella Riepilogativa -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-table"></i>
                        Riepilogo Dispositivi
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <!-- ✅ TABELLA CON STRUTTURA CORRETTA -->
                        <table id="summaryTable" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Distanza (km)</th>
                                    <th>Durata Totale</th>
                                    <th>Velocità Media</th>
                                    <th>Velocità Max</th>
                                    <th>Soste</th>
                                    <th>Carburante</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in summary_data %}
                                <tr>
                                    <td>
                                        <strong>{{ device.device_name }}</strong><br>
                                        <small class="text-muted">ID: {{ device.deviceId }}</small>
                                    </td>
                                    <td>{{ "%.1f"|format(device.distance_km or 0) }}</td>
                                    <td>{{ device.duration_formatted or "0h 0m" }}</td>
                                    <td>{{ "%.1f km/h"|format(device.average_speed or 0) }}</td>
                                    <td>{{ "%.1f km/h"|format(device.max_speed or 0) }}</td>
                                    <td>{{ device.stops or 0 }}</td>
                                    <td>
                                        {% if device.fuel_consumed %}
                                            {{ "%.1f L"|format(device.fuel_consumed) }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-info device-details-btn"
                                                data-device="{{ device|tojson|e }}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <a href="{{ url_for('positions.history', device_id=device.deviceId, from=from, to=to) }}"
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-route"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <!-- ✅ FOOTER OPZIONALE PER TOTALI -->
                            <tfoot>
                                <tr class="font-weight-bold">
                                    <td>TOTALE</td>
                                    <td>{{ "%.1f"|format(totals.distance_km or 0) }}</td>
                                    <td>{{ totals.duration_formatted or "0h 0m" }}</td>
                                    <td colspan="5" class="text-muted">
                                        {{ summary_data|length }} dispositivi
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                {% if selected_devices %}
                    Nessun dato disponibile per il periodo selezionato.
                {% else %}
                    Seleziona dispositivi e intervallo di date per generare il report riepilogativo.
                {% endif %}
            </div>
            {% if not devices %}
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                Nessun dispositivo disponibile.
                <a href="{{ url_for('devices.add_device') }}">Aggiungi dispositivi</a> per iniziare.
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Dettagli Dispositivo -->
<div class="modal fade" id="deviceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-info-circle"></i>
                    Dettagli Dispositivo
                </h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="deviceDetailsContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let chartsVisible = false;
let summaryTableInstance = null; // ✅ VARIABILE PER TRACKING ISTANZA

$(document).ready(function() {
    console.log('🔧 Inizializzazione Summary Report');

    // ✅ INIZIALIZZA SELECT2 SICURAMENTE
    if (typeof $.fn.select2 !== 'undefined') {
        $('#deviceIds').select2({
            placeholder: 'Seleziona dispositivi...',
            allowClear: true,
            width: '100%'
        });
    }

    // ✅ INIZIALIZZA DATATABLES CON HELPER SICURO
    if ($('#summaryTable').length && typeof TraccarFleet !== 'undefined') {
        console.log('🔧 Inizializzazione DataTable Summary');

        // ✅ CONFIGURAZIONE SPECIFICA PER LA TABELLA SUMMARY
        summaryTableInstance = TraccarFleet.initDataTable('#summaryTable', {
            order: [[1, 'desc']], // Ordina per distanza decrescente
            columnDefs: [
                { orderable: false, targets: [7] }, // Disabilita ordinamento per colonna azioni
                { width: '20%', targets: [0] },      // Colonna dispositivo più larga
                { width: '12%', targets: [1] },      // Distanza
                { width: '10%', targets: [2, 3] },   // Durata, velocità media
                { width: '8%', targets: [4, 5, 6] }, // Velocità max, soste, carburante
                { width: '10%', targets: [7] },      // Azioni
                // ✅ FORMATTAZIONE CELLE
                {
                    targets: [1], // Distanza
                    className: 'text-right'
                },
                {
                    targets: [2, 3, 4], // Durata, velocità
                    className: 'text-center'
                }
            ],
            pageLength: 25,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Tutti"]],
            // ✅ CONFIGURAZIONE RESPONSIVE
            responsive: {
                details: {
                    type: 'column',
                    target: 'tr'
                }
            },
            // ✅ CALLBACK POST-INIZIALIZZAZIONE
            initComplete: function(settings, json) {
                console.log('✅ DataTable Summary inizializzato con successo');

                // Applica stili personalizzati se necessario
                $('#summaryTable_wrapper').addClass('summary-table-wrapper');
            }
        });

        if (summaryTableInstance) {
            console.log('✅ Summary DataTable instance created successfully');
        } else {
            console.error('❌ Failed to create Summary DataTable instance');
        }
    }

    // ✅ EVENT HANDLERS SICURI
    $(document).on('click', '.device-details-btn', function(e) {
        e.preventDefault();

        try {
            const deviceData = $(this).data('device');
            if (deviceData) {
                showDeviceDetails(deviceData);
            } else {
                console.warn('Device data not found');
                showToast('Dati dispositivo non disponibili', 'warning');
            }
        } catch (error) {
            console.error('Error showing device details:', error);
            showToast('Errore caricamento dettagli', 'error');
        }
    });

    // ✅ IMPOSTA DATE PREDEFINITE SE NON SPECIFICATE
    if (!$('#from').val() && !$('#to').val()) {
        const now = new Date();
        const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

        $('#from').val(lastWeek.toISOString().slice(0, 16));
        $('#to').val(now.toISOString().slice(0, 16));
    }

    console.log('✅ Summary Report inizializzazione completata');
});

// ✅ FUNZIONE PER MOSTRARE DETTAGLI DISPOSITIVO
function showDeviceDetails(device) {
    try {
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-mobile-alt"></i> Informazioni Dispositivo</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Nome:</strong></td><td>${device.device_name || 'N/A'}</td></tr>
                        <tr><td><strong>ID:</strong></td><td>${device.deviceId || 'N/A'}</td></tr>
                        <tr><td><strong>Stato:</strong></td><td>
                            <span class="badge badge-${device.online ? 'success' : 'secondary'}">
                                ${device.online ? 'Online' : 'Offline'}
                            </span>
                        </td></tr>
                    </table>

                    <h6><i class="fas fa-road"></i> Prestazioni</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Distanza:</strong></td><td>${device.distance_km ? device.distance_km.toFixed(1) + ' km' : 'N/A'}</td></tr>
                        <tr><td><strong>Durata:</strong></td><td>${device.duration_formatted || 'N/A'}</td></tr>
                        <tr><td><strong>Velocità Media:</strong></td><td>${device.average_speed ? device.average_speed.toFixed(1) + ' km/h' : 'N/A'}</td></tr>
                        <tr><td><strong>Velocità Max:</strong></td><td>${device.max_speed ? device.max_speed.toFixed(1) + ' km/h' : 'N/A'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-pause-circle"></i> Soste e Consumi</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Numero Soste:</strong></td><td>${device.stops || 0}</td></tr>
                        <tr><td><strong>Tempo Soste:</strong></td><td>${device.stop_duration_formatted || 'N/A'}</td></tr>
                        <tr><td><strong>Carburante:</strong></td><td>
                            ${device.fuel_consumed ? device.fuel_consumed.toFixed(1) + ' L' : 'N/A'}
                        </td></tr>
                    </table>

                    <h6><i class="fas fa-clock"></i> Tempi</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Tempo Movimento:</strong></td><td>${device.moving_duration_formatted || 'N/A'}</td></tr>
                        <tr><td><strong>Tempo Fermo:</strong></td><td>${device.stopped_duration_formatted || 'N/A'}</td></tr>
                    </table>
                </div>
            </div>
        `;

        $('#deviceDetailsContent').html(content);
        $('#deviceDetailsModal').modal('show');

    } catch (error) {
        console.error('Error generating device details:', error);
        showToast('Errore nella generazione dei dettagli', 'error');
    }
}

// ✅ FUNZIONE PER ESPORTARE DATI
function exportSummaryData() {
    if (summaryTableInstance) {
        // Se hai pulsanti di esportazione DataTables
        summaryTableInstance.button('.buttons-excel').trigger();
    } else {
        showToast('Tabella non disponibile per esportazione', 'warning');
    }
}

// ✅ CLEANUP AL CAMBIO PAGINA
$(window).on('beforeunload', function() {
    if (summaryTableInstance) {
        try {
            summaryTableInstance.destroy();
        } catch (e) {
            console.warn('Error destroying DataTable:', e);
        }
    }
});
</script>
{% endblock %}