{% extends "base.html" %}

{% block title %}Report Viaggi - {{ app_name }}{% endblock %}

{% block page_title %}Report Viaggi{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('reports.reports_index') }}">Report</a></li>
<li class="breadcrumb-item active">Viaggi</li>
{% endblock %}

{% block head_css %}
<style>
.trip-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
}
.trip-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}
.trip-summary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
}
.metric-card {
    background: white;
    border-radius: 8px;
    transition: transform 0.2s;
}
.metric-card:hover {
    transform: scale(1.02);
}
</style>
{% endblock %}

{% block content %}
<!-- Filtri Report -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-filter"></i>
            Filtri Report Viaggi
        </h3>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('reports.trips') }}" class="form-inline">
            <input type="hidden" name="generate" value="1">

            <!-- Selezione Dispositivi -->
            <div class="form-group mr-3 mb-3">
                <label for="deviceIds" class="mr-2">Dispositivi:</label>
                <select name="deviceId" id="deviceIds" class="form-control" multiple style="width: 250px;">
                    {% for device in devices %}
                    <option value="{{ device.id }}"
                            {% if selected_devices and device.id in selected_devices %}selected{% endif %}>
                        {{ device.name }} ({{ device.uniqueId }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Data Inizio -->
            <div class="form-group mr-3 mb-3">
                <label for="from" class="mr-2">Da:</label>
                <input type="datetime-local"
                       id="from"
                       name="from"
                       class="form-control"
                       value="{{ from_date or '' }}">
            </div>

            <!-- Data Fine -->
            <div class="form-group mr-3 mb-3">
                <label for="to" class="mr-2">A:</label>
                <input type="datetime-local"
                       id="to"
                       name="to"
                       class="form-control"
                       value="{{ to_date or '' }}">
            </div>

            <!-- Bottone Genera -->
            <div class="form-group mb-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-chart-line"></i>
                    Genera Report
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Risultati Report -->
{% if trips %}
<!-- Statistiche Riepilogative -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card trip-summary">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <div class="metric-card p-3 text-center">
                            <i class="fas fa-route fa-2x text-primary mb-2"></i>
                            <h4 class="text-primary">{{ trips|length }}</h4>
                            <p class="text-muted mb-0">Viaggi Totali</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="metric-card p-3 text-center">
                            <i class="fas fa-road fa-2x text-success mb-2"></i>
                            <h4 class="text-success">{{ "%.1f"|format(trips|sum(attribute='distance_km')|default(0)) }}</h4>
                            <p class="text-muted mb-0">Km Totali</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="metric-card p-3 text-center">
                            <i class="fas fa-tachometer-alt fa-2x text-warning mb-2"></i>
                            <h4 class="text-warning">{{ "%.0f"|format(trips|map(attribute='maxSpeed_kmh')|list|max|default(0)) }}</h4>
                            <p class="text-muted mb-0">Vel. Max (km/h)</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="metric-card p-3 text-center">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            {% set total_duration = trips|sum(attribute='duration')|default(0) %}
                            <h4 class="text-info">{{ "%.1f"|format(total_duration / 3600) }}</h4>
                            <p class="text-muted mb-0">Ore Totali</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista Viaggi -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-list"></i>
            Dettaglio Viaggi ({{ trips|length }})
        </h3>
        <div class="card-tools">
            <button class="btn btn-sm btn-success" onclick="exportTrips()">
                <i class="fas fa-download"></i>
                Esporta
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" id="tripsTable">
                <thead class="bg-light">
                    <tr>
                        <th><i class="fas fa-mobile-alt"></i> Dispositivo</th>
                        <th><i class="fas fa-play"></i> Inizio</th>
                        <th><i class="fas fa-stop"></i> Fine</th>
                        <th><i class="fas fa-clock"></i> Durata</th>
                        <th><i class="fas fa-road"></i> Distanza</th>
                        <th><i class="fas fa-tachometer-alt"></i> Vel. Max</th>
                        <th><i class="fas fa-chart-line"></i> Vel. Media</th>
                        <th><i class="fas fa-cogs"></i> Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trip in trips %}
                    <tr>
                        <td>
                            <strong>{{ trip.device_name }}</strong>
                            <br>
                            <small class="text-muted">ID: {{ trip.deviceId }}</small>
                        </td>
                        <td>
                            <i class="fas fa-calendar-alt text-success"></i>
                            {{ trip.startTime|format_datetime if trip.startTime else 'N/A' }}
                            <br>
                            {% if trip.startAddress %}
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ trip.startAddress[:50] }}{% if trip.startAddress|length > 50 %}...{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            <i class="fas fa-calendar-alt text-danger"></i>
                            {{ trip.endTime|format_datetime if trip.endTime else 'N/A' }}
                            <br>
                            {% if trip.endAddress %}
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ trip.endAddress[:50] }}{% if trip.endAddress|length > 50 %}...{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.duration %}
                                {% set hours = (trip.duration // 3600)|int %}
                                {% set minutes = ((trip.duration % 3600) // 60)|int %}
                                <span class="badge badge-info">
                                    {{ "%02d:%02d"|format(hours, minutes) }}
                                </span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.distance_km %}
                                <span class="badge badge-primary">
                                    {{ "%.2f"|format(trip.distance_km) }} km
                                </span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.maxSpeed_kmh %}
                                <span class="badge badge-warning">
                                    {{ "%.0f"|format(trip.maxSpeed_kmh) }} km/h
                                </span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.averageSpeed_kmh %}
                                <span class="badge badge-secondary">
                                    {{ "%.0f"|format(trip.averageSpeed_kmh) }} km/h
                                </span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary"
                                        onclick="showTripOnMap({{ trip.deviceId }}, '{{ trip.startTime }}', '{{ trip.endTime }}')"
                                        title="Visualizza su mappa">
                                    <i class="fas fa-map"></i>
                                </button>
                                <button class="btn btn-outline-info"
                                        onclick="showTripDetails({{ trip|tojson }})"
                                        title="Dettagli">
                                    <i class="fas fa-info"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<!-- Nessun Risultato -->
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-route fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Nessun viaggio trovato</h4>
        <p class="text-muted">
            {% if request.args.get('generate') %}
                Nessun viaggio trovato per i filtri selezionati.
            {% else %}
                Seleziona dispositivi e intervallo di date per generare il report.
            {% endif %}
        </p>
        {% if not devices %}
        <div class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-triangle"></i>
            Nessun dispositivo disponibile. <a href="{{ url_for('devices.add_device') }}">Aggiungi dispositivi</a> per iniziare.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Modal Dettagli Viaggio -->
<div class="modal fade" id="tripDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-info-circle"></i>
                    Dettagli Viaggio
                </h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="tripDetailsContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inizializza Select2 per dispositivi
    $('#deviceIds').select2({
        placeholder: 'Seleziona dispositivi...',
        allowClear: true,
        width: '100%'
    });

    // Inizializza DataTables
    if ($('#tripsTable').length) {
        $('#tripsTable').DataTable({
            responsive: true,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/Italian.json'
            },
            order: [[1, 'desc']], // Ordina per data inizio decrescente
            columnDefs: [
                { orderable: false, targets: [7] } // Disabilita ordinamento per colonna azioni
            ]
        });
    }

    // Imposta date predefinite se non specificate
    if (!$('#from').val() && !$('#to').val()) {
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

        $('#from').val(yesterday.toISOString().slice(0, 16));
        $('#to').val(now.toISOString().slice(0, 16));
    }
});

function showTripOnMap(deviceId, startTime, endTime) {
    // Apri mappa in una nuova finestra/tab
    const url = `{{ url_for('positions.position_history') }}?deviceId=${deviceId}&from=${startTime}&to=${endTime}&load=1&showMap=1`;
    window.open(url, '_blank');
}

function showTripDetails(trip) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-mobile-alt"></i> Dispositivo</h6>
                <p><strong>${trip.device_name}</strong> (ID: ${trip.deviceId})</p>

                <h6><i class="fas fa-calendar-alt"></i> Periodo</h6>
                <p>
                    <strong>Inizio:</strong> ${trip.startTime || 'N/A'}<br>
                    <strong>Fine:</strong> ${trip.endTime || 'N/A'}
                </p>

                <h6><i class="fas fa-map-marker-alt"></i> Posizioni</h6>
                <p>
                    <strong>Partenza:</strong><br>
                    <small>${trip.startAddress || 'Indirizzo non disponibile'}</small><br>
                    <strong>Arrivo:</strong><br>
                    <small>${trip.endAddress || 'Indirizzo non disponibile'}</small>
                </p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-chart-bar"></i> Statistiche</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Distanza:</td>
                        <td><strong>${trip.distance_km ? trip.distance_km.toFixed(2) + ' km' : 'N/A'}</strong></td>
                    </tr>
                    <tr>
                        <td>Durata:</td>
                        <td><strong>${trip.duration ? Math.floor(trip.duration / 3600) + 'h ' + Math.floor((trip.duration % 3600) / 60) + 'm' : 'N/A'}</strong></td>
                    </tr>
                    <tr>
                        <td>Vel. Massima:</td>
                        <td><strong>${trip.maxSpeed_kmh ? trip.maxSpeed_kmh.toFixed(0) + ' km/h' : 'N/A'}</strong></td>
                    </tr>
                    <tr>
                        <td>Vel. Media:</td>
                        <td><strong>${trip.averageSpeed_kmh ? trip.averageSpeed_kmh.toFixed(0) + ' km/h' : 'N/A'}</strong></td>
                    </tr>
                </table>

                <h6><i class="fas fa-fuel-pump"></i> Consumi Stimati</h6>
                <p>
                    {% raw %}
                    <small class="text-muted">
                        Consumo stimato: ${trip.distance_km ? (trip.distance_km * 0.08).toFixed(2) + ' L' : 'N/A'}
                        <br>
                        (Stima basata su 8L/100km)
                    </small>
                    {% endraw %}
                </p>
            </div>
        </div>
    `;

    $('#tripDetailsContent').html(content);
    $('#tripDetailsModal').modal('show');
}

function exportTrips() {
    // Implementa esportazione (CSV, Excel, PDF)
    alert('Funzione di esportazione in sviluppo');
}
</script>

<!-- Select2 CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}