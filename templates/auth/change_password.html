<!-- Copyright 2025 SILICONDEV SPA -->
<!-- Filename: templates/auth/change_password.html -->
<!-- Description: Change password page -->

{% extends "base.html" %}

{% block title %}Cambia Password - AsteImmobili{% endblock %}

{% block page_title %}Cambia Password{% endblock %}

{% block page_actions %}
    <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Torna al Profilo
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">

        <!-- Security Info Alert -->
        <div class="alert alert-info mb-4">
            <i class="bi bi-shield-check me-2"></i>
            <strong>Sicurezza Account:</strong> Cambia regolarmente la password per mantenere il tuo account sicuro.
        </div>

        <div class="card shadow">
            <div class="card-header bg-warning text-dark text-center">
                <h5 class="mb-0">
                    <i class="bi bi-key me-2"></i>
                    Modifica Password
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('auth.change_password') }}" class="needs-validation" novalidate>

                    <!-- Current Password -->
                    <div class="mb-4">
                        <label for="current_password" class="form-label">Password Attuale *</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-lock"></i>
                            </span>
                            <input type="password" class="form-control" id="current_password" name="current_password"
                                   placeholder="Inserisci la password attuale" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                <i class="bi bi-eye" id="toggleCurrentPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">
                            La password attuale è richiesta.
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="new_password" class="form-label">Nuova Password *</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-lock-fill"></i>
                            </span>
                            <input type="password" class="form-control" id="new_password" name="new_password"
                                   placeholder="Inserisci nuova password" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                <i class="bi bi-eye" id="toggleNewPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">
                            La nuova password deve essere almeno 6 caratteri.
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" id="passwordStrengthBar" role="progressbar"
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small id="passwordStrengthText" class="form-text text-muted">
                                Forza password: <span id="strengthLevel">Non valutata</span>
                            </small>
                        </div>

                        <!-- Password Requirements -->
                        <div class="mt-2">
                            <small class="text-muted">Requisiti password:</small>
                            <ul class="list-unstyled small text-muted mt-1">
                                <li id="req-length">
                                    <i class="bi bi-circle me-1"></i>
                                    Almeno 6 caratteri
                                </li>
                                <li id="req-letter">
                                    <i class="bi bi-circle me-1"></i>
                                    Almeno una lettera
                                </li>
                                <li id="req-number">
                                    <i class="bi bi-circle me-1"></i>
                                    Almeno un numero
                                </li>
                                <li id="req-special">
                                    <i class="bi bi-circle me-1"></i>
                                    Almeno un simbolo (consigliato)
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">Conferma Nuova Password *</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-check-square"></i>
                            </span>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                   placeholder="Ripeti la nuova password" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="bi bi-eye" id="toggleConfirmPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback" id="confirmPasswordFeedback">
                            Le password devono coincidere.
                        </div>
                    </div>

                    <!-- Security Tips -->
                    <div class="alert alert-light border">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb me-2"></i>
                            Consigli per una password sicura:
                        </h6>
                        <ul class="mb-0 small">
                            <li>Usa una combinazione di lettere maiuscole e minuscole</li>
                            <li>Includi numeri e simboli speciali</li>
                            <li>Evita parole comuni o informazioni personali</li>
                            <li>Non riutilizzare password di altri siti</li>
                        </ul>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" id="submitButton">
                            <i class="bi bi-shield-check me-2"></i>
                            Cambia Password
                        </button>

                        <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-2"></i>
                            Annulla
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Additional Security Info -->
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informazioni Sicurezza
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        <strong>Account collegato a Google:</strong>
                        {% if current_user.google_id %}
                            <span class="text-success">
                                <i class="bi bi-check-circle me-1"></i>
                                Sì, puoi anche accedere con Google
                            </span>
                        {% else %}
                            <span class="text-muted">
                                <i class="bi bi-x-circle me-1"></i>
                                No, solo password locale
                            </span>
                        {% endif %}
                    </p>

                    <p class="small text-muted mb-0">
                        <strong>Ultimo cambio password:</strong>
                        {{ current_user.updated_at.strftime('%d/%m/%Y') if current_user.updated_at else 'Mai cambiata' }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.password-strength-weak {
    background-color: #dc3545 !important;
}

.password-strength-fair {
    background-color: #ffc107 !important;
}

.password-strength-good {
    background-color: #20c997 !important;
}

.password-strength-strong {
    background-color: #198754 !important;
}

.requirement-met {
    color: #198754 !important;
}

.requirement-met i {
    color: #198754;
}

.requirement-met i:before {
    content: "\F26A"; /* bi-check-circle */
}

.form-control.is-valid {
    border-color: #198754;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.input-group .btn {
    border-left: 0;
}

.alert-light {
    background-color: #f8f9fa;
    border-color: #e9ecef;
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggles
    const passwordToggles = [
        { input: 'current_password', button: 'toggleCurrentPassword', icon: 'toggleCurrentPasswordIcon' },
        { input: 'new_password', button: 'toggleNewPassword', icon: 'toggleNewPasswordIcon' },
        { input: 'confirm_password', button: 'toggleConfirmPassword', icon: 'toggleConfirmPasswordIcon' }
    ];

    passwordToggles.forEach(function(toggle) {
        const input = document.getElementById(toggle.input);
        const button = document.getElementById(toggle.button);
        const icon = document.getElementById(toggle.icon);

        button.addEventListener('click', function() {
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });

    // Password strength checker
    const newPasswordInput = document.getElementById('new_password');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('strengthLevel');

    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        updatePasswordStrength(strength);
        checkPasswordRequirements(password);
    });

    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];

        // Length check
        if (password.length >= 6) score += 1;
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;

        // Character variety
        if (/[a-z]/.test(password)) score += 1;
        if (/[A-Z]/.test(password)) score += 1;
        if (/[0-9]/.test(password)) score += 1;
        if (/[^A-Za-z0-9]/.test(password)) score += 2;

        return Math.min(score, 8);
    }

    function updatePasswordStrength(score) {
        const percentage = (score / 8) * 100;
        strengthBar.style.width = percentage + '%';

        // Remove previous classes
        strengthBar.classList.remove('password-strength-weak', 'password-strength-fair',
                                    'password-strength-good', 'password-strength-strong');

        if (score <= 2) {
            strengthBar.classList.add('password-strength-weak');
            strengthText.textContent = 'Debole';
            strengthText.className = 'text-danger';
        } else if (score <= 4) {
            strengthBar.classList.add('password-strength-fair');
            strengthText.textContent = 'Discreta';
            strengthText.className = 'text-warning';
        } else if (score <= 6) {
            strengthBar.classList.add('password-strength-good');
            strengthText.textContent = 'Buona';
            strengthText.className = 'text-info';
        } else {
            strengthBar.classList.add('password-strength-strong');
            strengthText.textContent = 'Forte';
            strengthText.className = 'text-success';
        }
    }

    function checkPasswordRequirements(password) {
        const requirements = [
            { id: 'req-length', test: password.length >= 6 },
            { id: 'req-letter', test: /[a-zA-Z]/.test(password) },
            { id: 'req-number', test: /[0-9]/.test(password) },
            { id: 'req-special', test: /[^A-Za-z0-9]/.test(password) }
        ];

        requirements.forEach(function(req) {
            const element = document.getElementById(req.id);
            if (req.test) {
                element.classList.add('requirement-met');
            } else {
                element.classList.remove('requirement-met');
            }
        });
    }

    // Password confirmation validation
    const confirmPasswordInput = document.getElementById('confirm_password');
    const confirmFeedback = document.getElementById('confirmPasswordFeedback');

    function validatePasswordConfirmation() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword && newPassword !== confirmPassword) {
            confirmPasswordInput.setCustomValidity('Le password non coincidono');
            confirmPasswordInput.classList.add('is-invalid');
            confirmPasswordInput.classList.remove('is-valid');
        } else if (confirmPassword) {
            confirmPasswordInput.setCustomValidity('');
            confirmPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.add('is-valid');
        }
    }

    newPasswordInput.addEventListener('input', validatePasswordConfirmation);
    confirmPasswordInput.addEventListener('input', validatePasswordConfirmation);

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        } else {
            // Loading state
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cambiando password...';
        }
        form.classList.add('was-validated');
    });

    // Prevent form submission if passwords don't match
    form.addEventListener('submit', function(event) {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword !== confirmPassword) {
            event.preventDefault();
            event.stopPropagation();
            confirmPasswordInput.focus();
        }
    });

    // Auto-focus first field
    document.getElementById('current_password').focus();
});
</script>
{% endblock %}