<!-- Copyright 2025 SILICONDEV SPA -->
<!-- Filename: templates/auth/edit_profile.html -->
<!-- Description: Edit user profile page -->

{% extends "base.html" %}

{% block title %}Modifica Profilo - AsteImmobili{% endblock %}

{% block page_title %}Modifica Profilo{% endblock %}

{% block page_actions %}
    <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Torna al Profilo
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <form method="POST" action="{{ url_for('auth.edit_profile') }}" class="needs-validation" novalidate>

            <!-- Personal Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>
                        Informazioni Personali
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="first_name" name="first_name"
                                   value="{{ user.first_name }}" maxlength="50" required>
                            <div class="invalid-feedback">
                                Il nome è richiesto.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Cognome *</label>
                            <input type="text" class="form-control" id="last_name" name="last_name"
                                   value="{{ user.last_name }}" maxlength="50" required>
                            <div class="invalid-feedback">
                                Il cognome è richiesto.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-at"></i>
                                </span>
                                <input type="text" class="form-control" id="username" name="username"
                                       value="{{ user.username or '' }}" maxlength="80"
                                       placeholder="Username opzionale">
                            </div>
                            <small class="form-text text-muted">
                                Se vuoto, verrà usato nome e cognome come display name.
                            </small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Telefono</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-telephone"></i>
                                </span>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                       value="{{ user.phone or '' }}" maxlength="20"
                                       placeholder="+39 123 456 7890">
                            </div>
                        </div>
                    </div>

                    <!-- Email (readonly) -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-envelope"></i>
                            </span>
                            <input type="email" class="form-control" id="email" value="{{ user.email }}" readonly>
                            {% if user.google_id %}
                                <span class="input-group-text">
                                    <i class="bi bi-google text-danger" title="Account Google"></i>
                                </span>
                            {% endif %}
                        </div>
                        <small class="form-text text-muted">
                            L'email non può essere modificata. {% if user.google_id %}Account collegato a Google.{% endif %}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt me-2"></i>
                        Indirizzo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="address" class="form-label">Indirizzo</label>
                        <textarea class="form-control" id="address" name="address" rows="2"
                                  placeholder="Via, numero civico, interno...">{{ user.address or '' }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">Città</label>
                            <input type="text" class="form-control" id="city" name="city"
                                   value="{{ user.city or '' }}" maxlength="100"
                                   placeholder="Nome città">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="postal_code" class="form-label">CAP</label>
                            <input type="text" class="form-control" id="postal_code" name="postal_code"
                                   value="{{ user.postal_code or '' }}" maxlength="20"
                                   placeholder="00000">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="country" class="form-label">Paese</label>
                            <input type="text" class="form-control" id="country" name="country"
                                   value="{{ user.country or 'Italia' }}" maxlength="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Professional Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-briefcase me-2"></i>
                        Informazioni Professionali
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company_name" class="form-label">Azienda/Studio</label>
                            <input type="text" class="form-control" id="company_name" name="company_name"
                                   value="{{ user.company_name or '' }}" maxlength="200"
                                   placeholder="Nome azienda o studio professionale">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="license_number" class="form-label">Numero Albo</label>
                            <input type="text" class="form-control" id="license_number" name="license_number"
                                   value="{{ user.license_number or '' }}" maxlength="50"
                                   placeholder="N. iscrizione ordine professionale">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="vat_number" class="form-label">Partita IVA</label>
                            <input type="text" class="form-control" id="vat_number" name="vat_number"
                                   value="{{ user.vat_number or '' }}" maxlength="20"
                                   placeholder="IT12345678901">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Status (read-only) -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        Stato Account
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted">Stato</label>
                            <div>
                                <span class="badge bg-{{ 'success' if user.is_active else 'danger' }} fs-6">
                                    <i class="bi bi-{{ 'check-circle' if user.is_active else 'x-circle' }} me-1"></i>
                                    {{ 'Attivo' if user.is_active else 'Disattivo' }}
                                </span>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted">Verifica</label>
                            <div>
                                <span class="badge bg-{{ 'success' if user.is_verified else 'warning' }} fs-6">
                                    <i class="bi bi-{{ 'patch-check' if user.is_verified else 'exclamation-triangle' }} me-1"></i>
                                    {{ 'Verificato' if user.is_verified else 'Non Verificato' }}
                                </span>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted">Ruolo</label>
                            <div>
                                <span class="badge bg-{{ 'primary' if user.is_admin else 'secondary' }} fs-6">
                                    <i class="bi bi-{{ 'star' if user.is_admin else 'person' }} me-1"></i>
                                    {{ 'Amministratore' if user.is_admin else 'Utente' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted d-block">Registrato il:</small>
                            <div>{{ user.created_at.strftime('%d/%m/%Y %H:%M') if user.created_at else 'N/A' }}</div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">Ultimo accesso:</small>
                            <div>{{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else 'Mai' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Summary -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Riepilogo Attività
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="h4 text-primary">{{ user.properties.count() }}</div>
                            <small class="text-muted">Immobili Gestiti</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-success">
                                {% set active_auctions = 0 %}
                                {% for property in user.properties %}
                                    {% for auction in property.auctions %}
                                        {% if auction.status == 'active' %}
                                            {% set active_auctions = active_auctions + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                                {{ active_auctions }}
                            </div>
                            <small class="text-muted">Aste Attive</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-info">{{ user.bids.count() }}</div>
                            <small class="text-muted">Offerte Fatte</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-warning">{{ user.bids.filter_by(is_winning=True).count() }}</div>
                            <small class="text-muted">Offerte Vincenti</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg me-3">
                        <i class="bi bi-check-circle me-2"></i>
                        Salva Modifiche
                    </button>

                    <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary btn-lg me-3">
                        <i class="bi bi-x-circle me-2"></i>
                        Annulla
                    </a>

                    {% if not user.google_id %}
                        <a href="{{ url_for('auth.change_password') }}" class="btn btn-outline-warning btn-lg">
                            <i class="bi bi-key me-2"></i>
                            Cambia Password
                        </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-header h5 {
    font-weight: 600;
}

.form-control[readonly] {
    background-color: #e9ecef;
    opacity: 1;
}

.badge {
    font-size: 0.875rem;
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #ced4da;
}

@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .row.text-center > div {
        margin-bottom: 1rem;
    }
}

.needs-validation .form-control:invalid {
    border-color: #dc3545;
}

.needs-validation .form-control:valid {
    border-color: #198754;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Auto-format phone number
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.startsWith('39')) {
                // Italian number with country code
                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '+$1 $2 $3 $4');
            } else if (value.length <= 10) {
                // Italian mobile/landline
                value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3');
            } else {
                // International format
                value = '+' + value;
            }
            this.value = value.trim();
        }
    });

    // Auto-format VAT number
    const vatInput = document.getElementById('vat_number');
    vatInput.addEventListener('input', function() {
        let value = this.value.toUpperCase();

        // Remove non-alphanumeric
        value = value.replace(/[^A-Z0-9]/g, '');

        // Format Italian VAT (IT + 11 digits)
        if (value.length <= 2) {
            // Allow typing IT
            if (!'IT'.startsWith(value)) {
                value = value.replace(/[^A-Z]/g, '');
            }
        } else if (value.startsWith('IT')) {
            // IT + digits
            const digits = value.slice(2).replace(/[^\d]/g, '');
            value = 'IT' + digits.slice(0, 11);
        } else if (/^\d/.test(value)) {
            // If starts with digit, prepend IT
            value = 'IT' + value.slice(0, 11);
        }

        this.value = value;
    });

    // Auto-format postal code
    const postalInput = document.getElementById('postal_code');
    postalInput.addEventListener('input', function() {
        // Italian CAP format (5 digits)
        let value = this.value.replace(/\D/g, '');
        this.value = value.slice(0, 5);
    });

    // Username availability check (optional enhancement)
    const usernameInput = document.getElementById('username');
    let usernameTimeout;

    usernameInput.addEventListener('input', function() {
        clearTimeout(usernameTimeout);
        const username = this.value.trim();

        if (username.length >= 3 && username !== '{{ user.username or "" }}') {
            usernameTimeout = setTimeout(() => {
                // Could implement AJAX check for username availability
                console.log('Checking username availability:', username);
            }, 500);
        }
    });

    // Confirm form submission with changes
    const form = document.querySelector('.needs-validation');
    let formChanged = false;

    // Track changes
    const formInputs = form.querySelectorAll('input, textarea, select');
    formInputs.forEach(function(input) {
        const originalValue = input.value;
        input.addEventListener('input', function() {
            if (this.value !== originalValue) {
                formChanged = true;
            }
        });
    });

    // Warn on page leave if changes made
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Don't warn on form submit
    form.addEventListener('submit', function() {
        formChanged = false;
    });

    // Loading state on submit
    form.addEventListener('submit', function(event) {
        if (form.checkValidity()) {
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';
        }
    });
});
</script>
{% endblock %}