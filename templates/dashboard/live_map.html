<!-- templates/dashboard/live_map.html -->
{% extends "base.html" %}

{% block extra_css %}
<link href="https://unpkg.com/leaflet.fullscreen@latest/Control.FullScreen.css" rel="stylesheet" />
<style>
    body { overflow: hidden; }
    #map { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; z-index: 0; }
    .map-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .vehicle-card { transition: all 0.2s ease; }
    .vehicle-card:hover { transform: translateX(4px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .compact-scrollbar::-webkit-scrollbar { width: 4px; }
    .compact-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .compact-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .filter-btn { transition: all 0.2s ease; }
    .filter-btn.active { background: #3b82f6; color: white; }

    /* Fullscreen styles */
    .fullscreen #map { top: 0; }
    .fullscreen .left-sidebar,
    .fullscreen .right-panel,
    .fullscreen .bottom-bar,
    .fullscreen nav { display: none; }
    .leaflet-control-fullscreen {
        background: white;
        width: 30px;
        height: 30px;
        border-radius: 4px;
    }

    /* Enhanced popup container */
    .vehicle-popup-container .leaflet-popup-content-wrapper {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        padding: 0;
        border: 1px solid #e5e7eb;
    }

    .vehicle-popup-container .leaflet-popup-content {
        margin: 0;
        padding: 0;
        width: auto !important;
    }

    .vehicle-popup-container .leaflet-popup-tip {
        background: white;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<!-- Map Container -->
<div id="map"></div>

<!-- Left Vehicle List Sidebar -->
<div class="fixed left-6 top-24 z-20 w-80 max-h-[70vh] flex flex-col left-sidebar">
    <div class="map-panel rounded-xl shadow-xl">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 class="text-lg font-bold text-gray-900">Flotta Veicoli</h2>
                    <p class="text-sm text-gray-600" id="subtitleText">{{ vehicles|length }} veicoli</p>
                </div>
                <button onclick="toggleVehicleList()" class="p-1 hover:bg-gray-100 rounded-lg transition">
                    <svg id="toggleIcon" class="w-5 h-5 text-gray-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <button onclick="toggleCollapse()" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                </svg>
                Filtri avanzati
            </button>
        </div>

        <div id="filtersSection" class="p-4 border-b border-gray-200" style="display: none;">
            <!-- Filtri Gruppo -->
            <div class="mb-3">
                <label class="text-xs font-medium text-gray-700 block mb-1">Gruppo</label>
                <select id="groupFilter" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Tutti i gruppi</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtri Categoria -->
            <div>
                <label class="text-xs font-medium text-gray-700 block mb-1">Categoria</label>
                <select id="categoryFilter" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Tutte le categorie</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto mt-3 compact-scrollbar" id="vehicleListContainer" style="display: block;">
        <div id="vehicleList" class="space-y-2">
            <div class="text-center text-gray-500 py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p>Caricamento veicoli...</p>
            </div>
        </div>
    </div>
</div>

<!-- Right Info Panel -->
<div class="fixed right-6 top-24 z-20 w-64 space-y-3 right-panel">
    <div class="map-panel rounded-xl p-4 shadow-lg">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">üìä Statistiche Live</h3>
        <div class="space-y-3" id="quickStats">
            <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                    <span class="text-xs text-gray-600">Totale veicoli</span>
                </div>
                <span class="text-sm font-bold text-gray-900" id="totalVehicles">--</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-xs text-gray-600">In movimento</span>
                </div>
                <span class="text-sm font-bold text-green-600" id="movingVehicles">--</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-purple-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                    <span class="text-xs text-gray-600">Velocit√† media</span>
                </div>
                <span class="text-sm font-bold text-purple-600" id="avgSpeed">--</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-4 pt-3 border-t border-gray-200">
            <h4 class="text-xs font-medium text-gray-700 mb-2">üîß Azioni rapide</h4>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="liveMap.map.locate({setView: true, maxZoom: 16})"
                        class="text-xs px-2 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors">
                    üìç La mia posizione
                </button>
                <button onclick="liveMap.loadVehicles()"
                        class="text-xs px-2 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors">
                    üîÑ Aggiorna
                </button>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="map-panel rounded-xl p-4 shadow-lg">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">üéØ Legenda</h3>
        <div class="space-y-2">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs text-gray-600">In movimento</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                <span class="text-xs text-gray-600">Fermo</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="text-xs text-gray-600">Offline</span>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Control Bar -->
<div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 bottom-bar">
    <div class="map-panel rounded-full px-6 py-3 shadow-xl flex items-center gap-4">
        <button class="filter-btn active px-4 py-2 bg-blue-500 text-white rounded-full text-sm font-medium hover:bg-blue-600 transition-all"
                onclick="filterVehicles('all')">
            üöó Tutti i veicoli
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-gray-700 rounded-full text-sm font-medium hover:bg-gray-50 transition-all"
                onclick="filterVehicles('active')">
            üü¢ Solo attivi
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-gray-700 rounded-full text-sm font-medium hover:bg-gray-50 transition-all"
                onclick="filterVehicles('stopped')">
            üü° Fermi
        </button>

        <div class="h-6 w-px bg-gray-300"></div>

        <div class="flex items-center gap-2 text-sm">
            <div class="flex items-center gap-1">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs text-gray-500">Live</span>
            </div>
            <span class="text-xs text-gray-400">‚Ä¢</span>
            <span class="text-xs text-gray-500">Aggiornato: <span class="font-medium" id="lastUpdate">--</span></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet.fullscreen@1.0.2/dist/Leaflet.fullscreen.min.js"></script>
<script src="{{ url_for('static', filename='js/live-map-enhanced.js') }}"></script>
{% endblock %}