<!-- templates/dashboard/live_map.html -->
{% extends "base.html" %}

{% block extra_css %}
<style>
    body { overflow: hidden; }
    #map { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; z-index: 0; }
    .map-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .vehicle-card { transition: all 0.2s ease; }
    .vehicle-card:hover { transform: translateX(4px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .compact-scrollbar::-webkit-scrollbar { width: 4px; }
    .compact-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .compact-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
{% endblock %}

{% block content %}
<!-- Full Screen Map -->
<div id="map"></div>

<!-- Left Sidebar - Vehicle List -->
<div class="fixed left-6 top-24 bottom-6 z-20 w-80 map-panel rounded-2xl shadow-xl overflow-hidden flex flex-col">
    <div class="p-4 border-b border-gray-200">
        <h2 class="font-semibold text-gray-900">Live Tracking</h2>
        <p class="text-xs text-gray-500 mt-1">Real-time vehicle monitoring</p>
    </div>

    <div class="flex-1 overflow-y-auto p-3 space-y-2 compact-scrollbar" id="vehicleList">
        <div class="text-center text-gray-500 py-8">
            <p>Loading vehicles...</p>
        </div>
    </div>
</div>

<!-- Right Info Panel -->
<div class="fixed right-6 top-24 z-20 w-64 space-y-3">
    <div class="map-panel rounded-xl p-4 shadow-lg">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Stats</h3>
        <div class="space-y-2" id="quickStats">
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">Totale veicoli</span>
                <span class="text-sm font-bold text-gray-900" id="totalVehicles">--</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">In movimento</span>
                <span class="text-sm font-bold text-green-600" id="movingVehicles">--</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">Km totali oggi</span>
                <span class="text-sm font-bold text-blue-600" id="totalKm">--</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">Velocità media</span>
                <span class="text-sm font-bold text-purple-600" id="avgSpeed">--</span>
            </div>
        </div>
    </div>

    <div class="map-panel rounded-xl p-4 shadow-lg">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Alerts</h3>
        <div class="space-y-2" id="alertsList">
            <div class="text-xs text-gray-500 text-center py-2">No alerts</div>
        </div>
    </div>
</div>

<!-- Bottom Control Bar -->
<div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20">
    <div class="map-panel rounded-full px-6 py-2.5 shadow-xl flex items-center gap-4">
        <button class="px-4 py-1.5 bg-blue-500 text-white rounded-full text-sm font-medium hover:bg-blue-600" onclick="filterVehicles('all')">
            All Vehicles
        </button>
        <button class="px-4 py-1.5 bg-white text-gray-700 rounded-full text-sm hover:bg-gray-50" onclick="filterVehicles('active')">
            Active Only
        </button>
        <button class="px-4 py-1.5 bg-white text-gray-700 rounded-full text-sm hover:bg-gray-50" onclick="filterVehicles('stopped')">
            Stopped
        </button>
        <div class="h-4 w-px bg-gray-300"></div>
        <span class="text-xs text-gray-500">Updated: <span class="font-medium" id="lastUpdate">now</span></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    const map = L.map('map', {
        zoomControl: false
    }).setView([43.5, 11.5], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap, © CartoDB',
        maxZoom: 19
    }).addTo(map);

    L.control.zoom({ position: 'bottomleft' }).addTo(map);

    let vehicleMarkers = {};
    let allVehicles = [];
    let currentFilter = 'all';

    async function loadVehicles() {
        try {
            const response = await fetch('/api/vehicles');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const vehicles = await response.json();
            if (vehicles.error) throw new Error(vehicles.error);

            allVehicles = vehicles;
            updateVehicleList(vehicles);
            updateMapMarkers(vehicles);
            updateStats(vehicles);
        } catch (error) {
            console.error('Error loading vehicles:', error);
            document.getElementById('vehicleList').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <p class="font-semibold">Error loading vehicles</p>
                    <p class="text-xs mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    function updateVehicleList(vehicles) {
        const container = document.getElementById('vehicleList');
        if (!vehicles || vehicles.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No vehicles available</p></div>';
            return;
        }

        container.innerHTML = vehicles.map(v => {
            const status = v.status === 'online' ? 'active' : 'stopped';
            const color = status === 'active' ? 'green' : 'orange';
            const speed = v.speed || 0;
            const progress = v.progress || 0;

            return `
                <div class="vehicle-card map-panel rounded-lg p-3 shadow-sm cursor-pointer" onclick="focusVehicle(${v.id})">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-${color}-500 rounded-full ${status === 'active' ? 'animate-pulse' : ''}"></div>
                            <span class="font-semibold text-sm text-gray-900">${v.name}</span>
                        </div>
                        <span class="text-xs font-bold text-gray-700">${speed} km/h</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-2">${v.route || 'No route'}</p>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-${color}-500" style="width: ${progress}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${progress}%</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateMapMarkers(vehicles) {
        Object.values(vehicleMarkers).forEach(marker => marker.remove());
        vehicleMarkers = {};

        vehicles.forEach(v => {
            if (v.latitude && v.longitude) {
                const status = v.status === 'online' ? 'active' : 'stopped';
                const color = status === 'active' ? '#10b981' : '#f59e0b';

                const marker = L.circleMarker([v.latitude, v.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`
                    <div class="p-2">
                        <div class="font-semibold text-sm">${v.name}</div>
                        <div class="text-xs text-gray-600 mt-1">Speed: ${v.speed || 0} km/h</div>
                        <div class="text-xs text-gray-600">Status: ${status}</div>
                    </div>
                `);

                vehicleMarkers[v.id] = marker;
            }
        });
    }

    function updateStats(vehicles) {
        const total = vehicles.length;
        const online = vehicles.filter(v => v.status === 'online').length;
        const speeds = vehicles.filter(v => v.speed > 0).map(v => v.speed);
        const avgSpeed = speeds.length > 0 ? (speeds.reduce((a, b) => a + b, 0) / speeds.length).toFixed(1) : 0;

        document.getElementById('totalVehicles').textContent = total;
        document.getElementById('movingVehicles').textContent = online;
        document.getElementById('avgSpeed').textContent = `${avgSpeed} km/h`;
    }

    function focusVehicle(vehicleId) {
        const marker = vehicleMarkers[vehicleId];
        if (marker) {
            map.setView(marker.getLatLng(), 12);
            marker.openPopup();
        }
    }

    function filterVehicles(filter) {
        currentFilter = filter;
        let filtered = allVehicles;

        if (filter === 'active') {
            filtered = allVehicles.filter(v => v.status === 'online');
        } else if (filter === 'stopped') {
            filtered = allVehicles.filter(v => v.status !== 'online');
        }

        updateVehicleList(filtered);
    }

    // Auto-refresh
    setInterval(() => {
        loadVehicles();
        document.getElementById('lastUpdate').textContent = 'now';
    }, 5000);

    loadVehicles();
</script>
{% endblock %}