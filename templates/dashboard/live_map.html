<!-- templates/dashboard/live_map.html -->
{% extends "base.html" %}

{% block extra_css %}
<link href="https://unpkg.com/leaflet.fullscreen@latest/Control.FullScreen.css" rel="stylesheet" />
<style>
    body { overflow: hidden; }
    #map { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; z-index: 0; }
    .map-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .vehicle-card { transition: all 0.2s ease; }
    .vehicle-card:hover { transform: translateX(4px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .compact-scrollbar::-webkit-scrollbar { width: 4px; }
    .compact-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .compact-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .filter-btn { transition: all 0.2s ease; }
    .filter-btn.active { background: #3b82f6; color: white; }

    /* Enhanced popup styles */
    .vehicle-popup {
        min-width: 320px;
    }
    .vehicle-popup .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 8px 8px 0 0;
        margin: -12px -16px 12px -16px;
    }
    .vehicle-popup .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .vehicle-popup .status-active {
        background: #10b981;
        color: white;
    }
    .vehicle-popup .status-stopped {
        background: #f59e0b;
        color: white;
    }
    .vehicle-popup .status-offline {
        background: #ef4444;
        color: white;
    }

    /* Fullscreen styles */
    .fullscreen #map { top: 0; }
    .fullscreen .left-sidebar,
    .fullscreen .right-panel,
    .fullscreen .bottom-bar,
    .fullscreen nav { display: none; }
    .leaflet-control-fullscreen {
        background: white;
        width: 30px;
        height: 30px;
        border-radius: 4px;
    }
    .leaflet-control-fullscreen a {
        background: white;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
        #map { top: 56px; }

        .left-sidebar {
            left: 12px;
            top: 70px;
            bottom: auto;
            width: calc(100% - 24px);
            max-width: 320px;
            border-radius: 12px;
            transform: none;
            transition: none;
        }

        .left-sidebar.collapsed {
            height: auto;
            bottom: auto;
        }

        .right-panel {
            display: none;
        }

        .bottom-bar {
            bottom: 12px;
            left: 12px;
            right: 12px;
            transform: none;
        }

        .bottom-bar .map-panel {
            border-radius: 12px;
            padding: 8px 12px;
        }

        .bottom-bar button {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Mobile toggle button - hide it on mobile */
        .mobile-toggle {
            display: none;
        }

        .vehicle-popup {
            min-width: 280px;
        }
    }

    @media (min-width: 769px) {
        .mobile-toggle {
            display: none;
        }

        .left-sidebar {
            transform: translateX(0) !important;
        }

        .left-sidebar.collapsed {
            width: auto;
            height: auto;
            bottom: auto;
            right: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Full Screen Map -->
<div id="map"></div>

<!-- Left Sidebar - Vehicle List -->
<div class="fixed left-6 top-24 bottom-6 z-20 w-80 map-panel rounded-2xl shadow-xl overflow-hidden flex flex-col left-sidebar collapsed" id="sidebar">
    <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="font-semibold text-gray-900">Live Tracking</h2>
                <p class="text-xs text-gray-500 mt-1" id="subtitleText">Monitoraggio in tempo reale</p>
            </div>
            <button onclick="toggleCollapse()" class="p-1 hover:bg-gray-100 rounded-lg transition">
                <svg id="collapseIcon" class="w-5 h-5 text-gray-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>

        <div id="filtersSection" class="mt-3" style="display: none;">
            <!-- Filtri Gruppo -->
            <div>
                <label class="text-xs font-medium text-gray-700 block mb-1">Gruppo</label>
                <select id="groupFilter" class="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti i gruppi</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtri Categoria -->
            <div class="mt-2">
                <label class="text-xs font-medium text-gray-700 block mb-1">Categoria</label>
                <select id="categoryFilter" class="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutte le categorie</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-3 space-y-2 compact-scrollbar" id="vehicleListContainer" style="display: none;">
        <div id="vehicleList">
            <div class="text-center text-gray-500 py-8">
                <p>Caricamento veicoli...</p>
            </div>
        </div>
    </div>
</div>

<!-- Right Info Panel -->
<div class="fixed right-6 top-24 z-20 w-64 space-y-3 right-panel">
    <div class="map-panel rounded-xl p-4 shadow-lg">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Statistiche</h3>
        <div class="space-y-2" id="quickStats">
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">Totale veicoli</span>
                <span class="text-sm font-bold text-gray-900" id="totalVehicles">--</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">In movimento</span>
                <span class="text-sm font-bold text-green-600" id="movingVehicles">--</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600">Velocità media</span>
                <span class="text-sm font-bold text-purple-600" id="avgSpeed">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Control Bar -->
<div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 bottom-bar">
    <div class="map-panel rounded-full px-6 py-2.5 shadow-xl flex items-center gap-4">
        <button class="filter-btn active px-4 py-1.5 bg-blue-500 text-white rounded-full text-sm font-medium hover:bg-blue-600" onclick="filterVehicles('all')">
            Tutti i Veicoli
        </button>
        <button class="filter-btn px-4 py-1.5 bg-white text-gray-700 rounded-full text-sm hover:bg-gray-50" onclick="filterVehicles('active')">
            Solo Attivi
        </button>
        <button class="filter-btn px-4 py-1.5 bg-white text-gray-700 rounded-full text-sm hover:bg-gray-50" onclick="filterVehicles('stopped')">
            Fermi
        </button>
        <div class="h-4 w-px bg-gray-300"></div>
        <span class="text-xs text-gray-500">Aggiornato: <span class="font-medium" id="lastUpdate">ora</span></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet.fullscreen@1.0.2/dist/Leaflet.fullscreen.min.js"></script>
<script>
    // Initialize map with custom controls
    const map = L.map('map', {
        zoomControl: false,
        fullscreenControl: true,
        fullscreenControlOptions: {
            position: 'topleft'
        }
    }).setView([43.5, 11.5], 6);

    // Mappa base layers
    const baseLayers = {
        'Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CartoDB',
            maxZoom: 19
        }),
        'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri',
            maxZoom: 19
        }),
        'Dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CartoDB',
            maxZoom: 19
        }),
        'Street': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            maxZoom: 19
        })
    };

    // Add default layer
    baseLayers['Light'].addTo(map);

    // Custom zoom control in bottom right
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Layer control in bottom right
    L.control.layers(baseLayers, null, { position: 'bottomright' }).addTo(map);

    // Handle fullscreen events
    map.on('enterFullscreen', function(){
        document.body.classList.add('fullscreen');
    });

    map.on('exitFullscreen', function(){
        document.body.classList.remove('fullscreen');
    });

    let vehicleMarkers = {};
    let allVehicles = [];
    let currentFilter = 'all';
    let selectedGroup = '';
    let selectedCategory = '';

    // Event listeners per i filtri
    document.getElementById('groupFilter').addEventListener('change', (e) => {
        selectedGroup = e.target.value;
        applyFilters();
    });

    document.getElementById('categoryFilter').addEventListener('change', (e) => {
        selectedCategory = e.target.value;
        applyFilters();
    });

    async function loadVehicles() {
        try {
            const response = await fetch('/api/vehicles');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const vehicles = await response.json();
            if (vehicles.error) throw new Error(vehicles.error);

            allVehicles = vehicles;
            applyFilters();
        } catch (error) {
            console.error('Error loading vehicles:', error);
            document.getElementById('vehicleList').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <p class="font-semibold">Errore caricamento veicoli</p>
                    <p class="text-xs mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    function applyFilters() {
        let filtered = allVehicles;

        // Filtro stato
        if (currentFilter === 'active') {
            filtered = filtered.filter(v => v.status === 'online' && v.speed > 0);
        } else if (currentFilter === 'stopped') {
            filtered = filtered.filter(v => v.status === 'offline' || v.speed === 0);
        }

        // Filtro gruppo
        if (selectedGroup) {
            filtered = filtered.filter(v => v.groupId == selectedGroup);
        }

        // Filtro categoria
        if (selectedCategory) {
            filtered = filtered.filter(v => v.category === selectedCategory);
        }

        updateVehicleList(filtered);
        updateMapMarkers(filtered);
        updateStats(filtered);
    }

    function updateVehicleList(vehicles) {
        const container = document.getElementById('vehicleList');
        if (!vehicles || vehicles.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Nessun veicolo disponibile</p></div>';
            return;
        }

        container.innerHTML = vehicles.map(v => {
            const status = v.status === 'online' && v.speed > 0 ? 'active' : 'stopped';
            const color = status === 'active' ? 'green' : 'orange';
            const speed = v.speed || 0;

            return `
                <div class="vehicle-card map-panel rounded-lg p-3 shadow-sm cursor-pointer" onclick="focusVehicle(${v.id})">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-${color}-500 rounded-full ${status === 'active' ? 'animate-pulse' : ''}"></div>
                            <span class="font-semibold text-sm text-gray-900">${v.name}</span>
                        </div>
                        <span class="text-xs font-bold text-gray-700">${speed} km/h</span>
                    </div>
                    <p class="text-xs text-gray-600">${v.route || 'Nessun percorso'}</p>
                </div>
            `;
        }).join('');

        // Update subtitle with vehicle count
        document.getElementById('subtitleText').textContent = `${vehicles.length} veicoli`;
    }

    function updateMapMarkers(vehicles) {
        Object.values(vehicleMarkers).forEach(marker => marker.remove());
        vehicleMarkers = {};

        vehicles.forEach(v => {
            if (v.latitude && v.longitude) {
                const status = getVehicleStatus(v);
                const color = getStatusColor(status);

                const marker = L.circleMarker([v.latitude, v.longitude], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                // Enhanced popup with detailed information
                marker.bindPopup(createVehiclePopup(v), {
                    className: 'vehicle-popup',
                    maxWidth: 350,
                    offset: [0, -10]
                });

                vehicleMarkers[v.id] = marker;
            }
        });

        // Auto-fit bounds
        const bounds = Object.values(vehicleMarkers).map(m => m.getLatLng());
        if (bounds.length > 0) {
            map.fitBounds(L.latLngBounds(bounds), { padding: [50, 50] });
        }
    }

    function getVehicleStatus(vehicle) {
        if (vehicle.status === 'offline') return 'offline';
        if (vehicle.status === 'online' && vehicle.speed > 0) return 'active';
        return 'stopped';
    }

    function getStatusColor(status) {
        switch (status) {
            case 'active': return '#10b981';
            case 'stopped': return '#f59e0b';
            case 'offline': return '#ef4444';
            default: return '#6b7280';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'active': return 'In movimento';
            case 'stopped': return 'Fermo';
            case 'offline': return 'Offline';
            default: return 'Sconosciuto';
        }
    }

    function createVehiclePopup(vehicle) {
        const status = getVehicleStatus(vehicle);
        const statusText = getStatusText(status);
        const lastUpdate = vehicle.lastUpdate ? new Date(vehicle.lastUpdate).toLocaleString('it-IT') : 'N/A';
        const attributes = vehicle.attributes || {};

        return `
            <div class="vehicle-popup">
                <div class="header">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold">${vehicle.name}</h3>
                        <span class="status-badge status-${status}">${statusText}</span>
                    </div>
                    <p class="text-sm opacity-90 mt-1">${vehicle.uniqueId || 'N/A'}</p>
                </div>

                <div class="space-y-3">
                    <!-- Informazioni principali -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${vehicle.speed || 0}</div>
                            <div class="text-xs text-blue-800">km/h</div>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">${vehicle.course || 0}°</div>
                            <div class="text-xs text-purple-800">Direzione</div>
                        </div>
                    </div>

                    <!-- Posizione e tempo -->
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Coordinate:</span>
                            <span class="text-xs font-mono">${vehicle.latitude?.toFixed(6)}, ${vehicle.longitude?.toFixed(6)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Ultimo aggiornamento:</span>
                            <span class="text-xs">${lastUpdate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Altitudine:</span>
                            <span class="text-xs">${attributes.altitude || 0} m</span>
                        </div>
                    </div>

                    <!-- Informazioni aggiuntive -->
                    <div class="border-t pt-2 space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Categoria:</span>
                            <span class="text-xs">${vehicle.category || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Modello:</span>
                            <span class="text-xs">${vehicle.model || 'N/A'}</span>
                        </div>
                        ${vehicle.phone ? `
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Telefono:</span>
                            <span class="text-xs">${vehicle.phone}</span>
                        </div>
                        ` : ''}
                        ${attributes.batteryLevel ? `
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Batteria:</span>
                            <span class="text-xs">${attributes.batteryLevel}%</span>
                        </div>
                        ` : ''}
                        ${attributes.odometer ? `
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Odometro:</span>
                            <span class="text-xs">${(attributes.odometer / 1000).toFixed(1)} km</span>
                        </div>
                        ` : ''}
                        ${attributes.fuel ? `
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Carburante:</span>
                            <span class="text-xs">${attributes.fuel}%</span>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Azioni -->
                    <div class="flex gap-2 pt-2 border-t">
                        <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg"
                                onclick="window.open('/vehicles/${vehicle.id}', '_blank')">
                            Dettagli
                        </button>
                        <button class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs py-2 px-3 rounded-lg"
                                onclick="window.open('https://www.google.com/maps?q=${vehicle.latitude},${vehicle.longitude}', '_blank')">
                            Google Maps
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function updateStats(vehicles) {
        const total = vehicles.length;
        const moving = vehicles.filter(v => v.status === 'online' && v.speed > 0).length;
        const speeds = vehicles.filter(v => v.speed > 0).map(v => v.speed);
        const avgSpeed = speeds.length > 0 ? Math.round(speeds.reduce((a, b) => a + b, 0) / speeds.length) : 0;

        document.getElementById('totalVehicles').textContent = total;
        document.getElementById('movingVehicles').textContent = moving;
        document.getElementById('avgSpeed').textContent = avgSpeed + ' km/h';
    }

    function filterVehicles(filter) {
        currentFilter = filter;

        // Update button styles
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-500', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700');
        });

        event.target.classList.add('active', 'bg-blue-500', 'text-white');
        event.target.classList.remove('bg-white', 'text-gray-700');

        applyFilters();
    }

    function focusVehicle(vehicleId) {
        const marker = vehicleMarkers[vehicleId];
        if (marker) {
            map.setView(marker.getLatLng(), 15);
            marker.openPopup();
        }
    }

    // Auto-refresh
    setInterval(() => {
        loadVehicles();
        document.getElementById('lastUpdate').textContent = 'ora';
    }, 10000);

    // Initial load
    loadVehicles();

    // Collapse/Expand filters
    function toggleCollapse() {
        const sidebar = document.getElementById('sidebar');
        const filtersSection = document.getElementById('filtersSection');
        const vehicleListContainer = document.getElementById('vehicleListContainer');
        const icon = document.getElementById('collapseIcon');

        sidebar.classList.toggle('collapsed');

        if (sidebar.classList.contains('collapsed')) {
            // Collapse
            filtersSection.style.display = 'none';
            vehicleListContainer.style.display = 'none';
            icon.classList.add('rotate-180');
        } else {
            // Expand
            filtersSection.style.display = 'block';
            vehicleListContainer.style.display = 'flex';
            icon.classList.remove('rotate-180');
        }
    }
</script>
{% endblock %}