{% extends "base.html" %}

{% block title %}Immobili - Agenzia Immobiliare{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">I Nostri Immobili</h1>

    <!-- Filtri di ricerca -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-filter me-2"></i>Filtra Immobili
            </h5>
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="">Tutti i tipi</option>
                        <option value="appartamento" {{ 'selected' if filtri.tipo == 'appartamento' }}>Appartamento</option>
                        <option value="villa" {{ 'selected' if filtri.tipo == 'villa' }}>Villa</option>
                        <option value="ufficio" {{ 'selected' if filtri.tipo == 'ufficio' }}>Ufficio</option>
                        <option value="negozio" {{ 'selected' if filtri.tipo == 'negozio' }}>Negozio</option>
                        <option value="garage" {{ 'selected' if filtri.tipo == 'garage' }}>Garage</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Contratto</label>
                    <select name="contratto" class="form-select">
                        <option value="">Tutti</option>
                        <option value="vendita" {{ 'selected' if filtri.contratto == 'vendita' }}>Vendita</option>
                        <option value="affitto" {{ 'selected' if filtri.contratto == 'affitto' }}>Affitto</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Città</label>
                    <input type="text" name="citta" class="form-control" placeholder="Es. Milano, Roma..." value="{{ filtri.citta or '' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Prezzo Massimo (€)</label>
                    <input type="number" name="prezzo_max" class="form-control" placeholder="Es. 300000" value="{{ filtri.prezzo_max or '' }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Prezzo Minimo (€)</label>
                    <input type="number" name="prezzo_min" class="form-control" placeholder="Es. 100000" value="{{ filtri.prezzo_min or '' }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>Cerca
                    </button>
                    <a href="{{ url_for('lista_immobili') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-undo me-1"></i>Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Risultati ricerca -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            {% if immobili.total > 0 %}
                Trovati {{ immobili.total }} immobili
            {% else %}
                Nessun immobile trovato
            {% endif %}
        </h5>
        <div class="text-muted">
            Pagina {{ immobili.page }} di {{ immobili.pages }}
        </div>
    </div>

    <!-- Lista immobili -->
    <div class="row g-4">
        {% for immobile in immobili.items %}
        <div class="col-md-6 col-lg-4">
            <div class="card property-card h-100 shadow-sm">
                <div class="property-image position-relative">
                    <!-- Badge contratto -->
                    <span class="badge bg-{{ 'success' if immobile.contratto == 'vendita' else 'info' }} position-absolute top-0 start-0 m-2">
                        {{ immobile.contratto.title() }}
                    </span>
                    <!-- Badge tipo -->
                    <span class="badge bg-secondary position-absolute top-0 end-0 m-2">
                        {{ immobile.tipo.title() }}
                    </span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ immobile.titolo }}</h5>
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        {{ immobile.citta }}
                        {% if immobile.indirizzo %}, {{ immobile.indirizzo }}{% endif %}
                    </p>

                    <!-- Descrizione -->
                    {% if immobile.descrizione %}
                    <p class="card-text text-truncate">{{ immobile.descrizione }}</p>
                    {% endif %}

                    <!-- Prezzo -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="price-tag fs-5">
                            €{{ "{:,.0f}".format(immobile.prezzo) }}
                            {% if immobile.contratto == 'affitto' %}<small>/mese</small>{% endif %}
                        </span>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            {{ immobile.data_inserimento.strftime('%d/%m/%Y') }}
                        </small>
                    </div>

                    <!-- Caratteristiche -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <i class="fas fa-expand-arrows-alt text-primary"></i><br>
                            <small><strong>{{ immobile.superficie }}</strong> mq</small>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-bed text-primary"></i><br>
                            <small><strong>{{ immobile.locali }}</strong> locali</small>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-bath text-primary"></i><br>
                            <small><strong>{{ immobile.bagni }}</strong> bagni</small>
                        </div>
                    </div>

                    <!-- Bottone dettagli -->
                    <a href="{{ url_for('dettaglio_immobile', id=immobile.id) }}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-eye me-1"></i>Maggiori Dettagli
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center py-5">
                <i class="fas fa-info-circle fa-3x mb-3 text-info"></i>
                <h4>Nessun immobile trovato</h4>
                <p class="mb-0">Prova a modificare i filtri di ricerca per trovare quello che stai cercando.</p>
                <a href="{{ url_for('lista_immobili') }}" class="btn btn-primary mt-3">
                    <i class="fas fa-home me-1"></i>Vedi Tutti gli Immobili
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Paginazione -->
    {% if immobili.pages > 1 %}
    <nav class="mt-5" aria-label="Navigazione immobili">
        <ul class="pagination justify-content-center">
            <!-- Prima pagina -->
            {% if immobili.page > 2 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('lista_immobili', page=1, **filtri) }}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            {% endif %}

            <!-- Pagina precedente -->
            {% if immobili.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('lista_immobili', page=immobili.prev_num, **filtri) }}">
                    <i class="fas fa-angle-left"></i> Precedente
                </a>
            </li>
            {% endif %}

            <!-- Pagine numeriche -->
            {% for page_num in immobili.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num != immobili.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('lista_immobili', page=page_num, **filtri) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
                {% endif %}
            {% endfor %}

            <!-- Pagina successiva -->
            {% if immobili.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('lista_immobili', page=immobili.next_num, **filtri) }}">
                    Successivo <i class="fas fa-angle-right"></i>
                </a>
            </li>
            {% endif %}

            <!-- Ultima pagina -->
            {% if immobili.page < immobili.pages - 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('lista_immobili', page=immobili.pages, **filtri) }}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

    <!-- Info paginazione -->
    <div class="text-center text-muted mt-3">
        Mostrando {{ ((immobili.page - 1) * immobili.per_page + 1) }} -
        {{ (immobili.page * immobili.per_page) if immobili.page < immobili.pages else immobili.total }}
        di {{ immobili.total }} immobili
    </div>
    {% endif %}
</div>

<!-- Stili CSS aggiuntivi -->
<style>
.property-card {
    transition: all 0.3s ease;
    border: none;
}

.property-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.property-image {
    height: 220px;
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    background-image: url('https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80');
    background-size: cover;
    background-position: center;
}

.price-tag {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.1em;
}

.card-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.pagination .page-link {
    border-radius: 8px;
    margin: 0 2px;
    border: none;
    color: #495057;
}

.pagination .page-item.active .page-link {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border-color: #007bff;
}

.badge {
    font-size: 0.75em;
    padding: 0.4em 0.8em;
    border-radius: 12px;
}

.alert-info {
    border: none;
    background: linear-gradient(45deg, #d1ecf1, #bee5eb);
    border-radius: 15px;
}

/* Responsive */
@media (max-width: 768px) {
    .property-image {
        height: 180px;
    }

    .price-tag {
        font-size: 1em;
        padding: 6px 12px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Script per migliorare l'esperienza utente
document.addEventListener('DOMContentLoaded', function() {
    // Animazione cards al caricamento
    const cards = document.querySelectorAll('.property-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';

            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 100);
    });

    // Auto-submit del form filtri quando si cambia una select
    const selectFilters = document.querySelectorAll('select[name="tipo"], select[name="contratto"]');
    selectFilters.forEach(select => {
        select.addEventListener('change', function() {
            // Opzionale: auto-submit del form
            // this.form.submit();
        });
    });

    // Tooltip per le icone
    const icons = document.querySelectorAll('.fa-expand-arrows-alt, .fa-bed, .fa-bath');
    icons.forEach(icon => {
        icon.setAttribute('data-bs-toggle', 'tooltip');
        if (icon.classList.contains('fa-expand-arrows-alt')) {
            icon.setAttribute('title', 'Superficie');
        } else if (icon.classList.contains('fa-bed')) {
            icon.setAttribute('title', 'Numero locali');
        } else if (icon.classList.contains('fa-bath')) {
            icon.setAttribute('title', 'Numero bagni');
        }
    });

    // Inizializza i tooltip
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}