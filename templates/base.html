<!-- templates/base.html - SOLUZIONE DEFINITIVA -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fleet Manager Pro{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: saturate(180%) blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50">

    {% if session.get('user') %}
    <!-- Navigation Header (only for logged in users) -->
    <nav class="fixed top-0 left-0 right-0 z-30 panel px-6 py-3 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-6">
                <h1 class="text-lg font-bold text-gray-900">Fleet Manager Pro</h1>

                <div class="flex items-center gap-2">
                    <a href="{{ url_for('dashboard.index') }}"
                       class="px-4 py-1.5 {% if request.endpoint == 'dashboard.index' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} rounded-lg text-sm font-medium transition">
                        üìä Dashboard
                    </a>
                    <a href="{{ url_for('dashboard.live_map') }}"
                       class="px-4 py-1.5 {% if request.endpoint == 'dashboard.live_map' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} rounded-lg text-sm font-medium transition">
                        üó∫Ô∏è Live Map
                    </a>
                    <a href="{{ url_for('vehicles.list') }}"
                       class="px-4 py-1.5 {% if request.endpoint == 'vehicles.list' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} rounded-lg text-sm font-medium transition">
                        üöõ Vehicles
                    </a>
                    <a href="{{ url_for('reports.index') }}"
                       class="px-4 py-1.5 {% if request.endpoint == 'reports.index' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} rounded-lg text-sm font-medium transition">
                        üìà Reports
                    </a>
                    <a href="{{ url_for('alerts.index') }}"
                       class="px-4 py-1.5 {% if request.endpoint == 'alerts.index' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} rounded-lg text-sm font-medium transition">
                        ‚ö†Ô∏è Alerts
                    </a>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex gap-2 text-sm">
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-medium" id="activeCount">-- Active</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium" id="kmTotal">-- km</span>
                </div>

                <span class="text-sm text-gray-600">{{ session.user.name }}</span>
                <a href="{{ url_for('auth.logout') }}" class="px-4 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition">
                    Logout
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- SINGLE Content Block - used by ALL pages -->
    <main {% if session.get('user') %}class="pt-16"{% endif %}>
        {% block content %}{% endblock %}
    </main>

    {% if session.get('user') %}
    <script>
        async function updateLiveStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('activeCount').textContent = `${stats.onlineVehicles} Active`;
                    document.getElementById('kmTotal').textContent = `${stats.totalDistance} km`;
                }
            } catch (error) {
                console.error('Stats error:', error);
            }
        }
        setInterval(updateLiveStats, 10000);
        updateLiveStats();
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>
</html>