<!-- templates/timesheet/edit_entry.html - Edit Time Entry -->
{% extends "base.html" %}

{% block title %}Modifica Voce - Timesheet App{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-pencil-square"></i> Modifica Voce Temporale
                </h1>
                <div>
                    <a href="{{ url_for('timesheet.view_entry', entry_id=entry.id) }}" class="btn btn-outline-info">
                        <i class="bi bi-eye"></i> Visualizza
                    </a>
                    <a href="{{ url_for('timesheet.index') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Torna al Timesheet
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <span class="project-badge me-2" style="background-color: {{ entry.project.color }};"></span>
                        Modifica Voce - {{ entry.project.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="edit-entry-form">
                        <div class="row">
                            <!-- Project Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="project_id" class="form-label">
                                    <i class="bi bi-folder"></i> Progetto *
                                </label>
                                <select class="form-select" id="project_id" name="project_id" required>
                                    {% for project in active_projects %}
                                    <option value="{{ project.id }}"
                                            {{ 'selected' if project.id == entry.project_id else '' }}
                                            data-color="{{ project.color }}"
                                            data-rate="{{ project.hourly_rate }}">
                                        {{ project.name }}
                                        {% if project.hourly_rate > 0 %}
                                        (€{{ "%.0f"|format(project.hourly_rate) }}/h)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Duration -->
                            <div class="col-md-6 mb-3">
                                <label for="duration_hours" class="form-label">
                                    <i class="bi bi-clock"></i> Durata (ore) *
                                </label>
                                <input type="number" class="form-control" id="duration_hours" name="duration_hours"
                                       step="0.25" min="0.25" max="24"
                                       value="{{ entry.duration_hours }}" required>
                                <div class="form-text">
                                    Durata attuale: {{ entry.duration_display }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Date -->
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">
                                    <i class="bi bi-calendar"></i> Data *
                                </label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                       value="{{ entry.start_time.strftime('%Y-%m-%d') }}" required>
                            </div>

                            <!-- Start Time -->
                            <div class="col-md-6 mb-3">
                                <label for="start_time" class="form-label">
                                    <i class="bi bi-clock-history"></i> Ora Inizio *
                                </label>
                                <input type="time" class="form-control" id="start_time" name="start_time"
                                       value="{{ entry.start_time.strftime('%H:%M') }}" required>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="bi bi-chat-text"></i> Descrizione *
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4"
                                      required>{{ entry.description }}</textarea>
                        </div>

                        <!-- Tags -->
                        <div class="mb-4">
                            <label for="tags" class="form-label">
                                <i class="bi bi-tags"></i> Tag (opzionali)
                            </label>
                            <input type="text" class="form-control" id="tags" name="tags"
                                   value="{{ entry.tags or '' }}"
                                   placeholder="sviluppo, meeting, debugging">
                            <div class="form-text">
                                Separare i tag con virgole
                            </div>
                        </div>

                        <!-- Current Info Display -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-info-circle"></i> Informazioni Attuali
                                </h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">Creata:</small>
                                        <div>{{ entry.created_at.strftime('%d/%m/%Y %H:%M') }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Modificata:</small>
                                        <div>{{ entry.updated_at.strftime('%d/%m/%Y %H:%M') }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Durata:</small>
                                        <div class="timer-display">{{ entry.duration_display }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Guadagno:</small>
                                        <div class="text-success">€{{ "%.2f"|format(entry.earnings) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Warning for Running Timer -->
                        {% if entry.is_running %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Attenzione!</strong> Questa voce ha il timer attualmente in corso.
                            Modificando i dati, il timer verrà fermato automaticamente.
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('timesheet.view_entry', entry_id=entry.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Annulla
                            </a>

                            <button type="submit" class="btn btn-success" data-original-text="Salva Modifiche">
                                <i class="bi bi-check-circle"></i> Salva Modifiche
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightning"></i> Azioni Rapide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setQuickDuration(0.5)">
                                30 minuti
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setQuickDuration(1)">
                                1 ora
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setQuickDuration(2)">
                                2 ore
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setQuickDuration(4)">
                                4 ore
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function setQuickDuration(hours) {
        document.getElementById('duration_hours').value = hours;
    }

    // Form validation
    document.getElementById('edit-entry-form').addEventListener('submit', function(e) {
        const description = document.getElementById('description').value.trim();
        if (description.length < 5) {
            e.preventDefault();
            alert('La descrizione deve essere di almeno 5 caratteri');
            return;
        }

        const duration = parseFloat(document.getElementById('duration_hours').value);
        if (duration < 0.25 || duration > 24) {
            e.preventDefault();
            alert('La durata deve essere tra 15 minuti (0.25) e 24 ore');
            return;
        }

        // Warn about running timer
        {% if entry.is_running %}
        if (!confirm('Modificando questa voce, il timer attualmente in corso verrà fermato. Continuare?')) {
            e.preventDefault();
            return;
        }
        {% endif %}
    });
</script>
{% endblock %}