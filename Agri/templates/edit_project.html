{% extends "base.html" %}

{% block title %}Modifica {{ project.name }}{% endblock %}

{% block content %}
<style>
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 5px;
        margin: 2rem 0 1rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-card {
        background: #f8f9fa;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-info {
        flex: 1;
    }

    .item-amount {
        font-size: 1.3rem;
        font-weight: bold;
        color: #667eea;
        margin-left: 1rem;
    }
</style>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>✏️ Modifica Progetto: {{ project.name }}</h2>
        <div>
            <a href="{{ url_for('view_report', project_id=project.id) }}" class="btn">📄 Visualizza Report</a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">⬅️ Torna alla Lista</a>
        </div>
    </div>
</div>

<!-- Info Base Progetto -->
<div class="card">
    <h3>📝 Informazioni Base</h3>
    <form method="POST" action="{{ url_for('update_project', project_id=project.id) }}">
        <div class="form-group">
            <label for="name">Nome Progetto *</label>
            <input type="text" id="name" name="name" required value="{{ project.name }}">
        </div>

        <div class="form-group">
            <label for="subtitle">Sottotitolo</label>
            <input type="text" id="subtitle" name="subtitle" value="{{ project.subtitle or '' }}">
        </div>

        <div class="form-group">
            <label for="tagline">Tagline/Descrizione</label>
            <textarea id="tagline" name="tagline">{{ project.tagline or '' }}</textarea>
        </div>

        <div class="grid">
            <div class="form-group">
                <label for="location">Posizione</label>
                <input type="text" id="location" name="location" value="{{ project.location or '' }}">
            </div>

            <div class="form-group">
                <label for="surface_ha">Superficie (ettari)</label>
                <input type="number" id="surface_ha" name="surface_ha" step="0.1" value="{{ project.surface_ha }}">
            </div>

            <div class="form-group">
                <label for="apartments">Numero Appartamenti</label>
                <input type="number" id="apartments" name="apartments" value="{{ project.apartments }}">
            </div>
        </div>

        <button type="submit" class="btn">💾 Aggiorna Informazioni</button>
    </form>
</div>

<!-- Investimenti -->
<div class="card">
    <div class="section-header">
        <h3 style="margin: 0; color: white;">💰 Investimenti Iniziali</h3>
        <span style="font-size: 1.2rem;">Totale: €{{ "{:,.0f}".format(project.investments|sum(attribute='amount')) }}</span>
    </div>

    {% for inv in project.investments %}
    <div class="item-card">
        <div class="item-info">
            <strong>{{ inv.name }}</strong>
        </div>
        <div style="display: flex; align-items: center;">
            <span class="item-amount">€{{ "{:,.0f}".format(inv.amount) }}</span>
            <form method="POST" action="{{ url_for('delete_investment', inv_id=inv.id) }}" style="margin-left: 1rem;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Sicuro di voler eliminare?')">🗑️</button>
            </form>
        </div>
    </div>
    {% endfor %}

    <h4 style="margin-top: 2rem;">➕ Aggiungi Investimento</h4>
    <form method="POST" action="{{ url_for('add_investment', project_id=project.id) }}">
        <div class="grid">
            <div class="form-group">
                <label for="inv_name">Nome Investimento</label>
                <input type="text" id="inv_name" name="name" required placeholder="es. Acquisto Proprietà">
            </div>
            <div class="form-group">
                <label for="inv_amount">Importo (€)</label>
                <input type="number" id="inv_amount" name="amount" step="0.01" required placeholder="0.00">
            </div>
        </div>
        <button type="submit" class="btn">💾 Aggiungi</button>
    </form>
</div>

<!-- Ricavi -->
<div class="card">
    <div class="section-header">
        <h3 style="margin: 0; color: white;">📈 Ricavi Annuali Previsti</h3>
        <span style="font-size: 1.2rem;">Totale: €{{ "{:,.0f}".format(project.revenues|sum(attribute='amount')) }}</span>
    </div>

    {% for rev in project.revenues %}
    <div class="item-card">
        <div class="item-info">
            <strong>{{ rev.name }}</strong>
        </div>
        <div style="display: flex; align-items: center;">
            <span class="item-amount">€{{ "{:,.0f}".format(rev.amount) }}</span>
            <form method="POST" action="{{ url_for('delete_revenue', rev_id=rev.id) }}" style="margin-left: 1rem;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Sicuro di voler eliminare?')">🗑️</button>
            </form>
        </div>
    </div>
    {% endfor %}

    <h4 style="margin-top: 2rem;">➕ Aggiungi Ricavo</h4>
    <form method="POST" action="{{ url_for('add_revenue', project_id=project.id) }}">
        <div class="grid">
            <div class="form-group">
                <label for="rev_name">Nome Ricavo</label>
                <input type="text" id="rev_name" name="name" required placeholder="es. Ospitalità">
            </div>
            <div class="form-group">
                <label for="rev_amount">Importo Annuale (€)</label>
                <input type="number" id="rev_amount" name="amount" step="0.01" required placeholder="0.00">
            </div>
        </div>
        <button type="submit" class="btn">💾 Aggiungi</button>
    </form>
</div>

<!-- Costi -->
<div class="card">
    <div class="section-header">
        <h3 style="margin: 0; color: white;">💸 Costi Operativi Annuali</h3>
        <span style="font-size: 1.2rem;">Totale: €{{ "{:,.0f}".format(project.costs|sum(attribute='amount')) }}</span>
    </div>

    {% set categories = project.costs|groupby('category') %}
    {% for category, costs in categories %}
    <h4 style="margin-top: 1.5rem; color: #e74c3c;">{{ category }}</h4>
    {% for cost in costs %}
    <div class="item-card">
        <div class="item-info">
            <strong>{{ cost.name }}</strong>
            {% if cost.detail %}
            <br><small style="color: #666;">{{ cost.detail }}</small>
            {% endif %}
        </div>
        <div style="display: flex; align-items: center;">
            <span class="item-amount" style="color: #e74c3c;">€{{ "{:,.0f}".format(cost.amount) }}</span>
            <form method="POST" action="{{ url_for('delete_cost', cost_id=cost.id) }}" style="margin-left: 1rem;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Sicuro di voler eliminare?')">🗑️</button>
            </form>
        </div>
    </div>
    {% endfor %}
    {% endfor %}

    <h4 style="margin-top: 2rem;">➕ Aggiungi Costo</h4>
    <form method="POST" action="{{ url_for('add_cost', project_id=project.id) }}">
        <div class="grid">
            <div class="form-group">
                <label for="cost_category">Categoria</label>
                <select id="cost_category" name="category" required>
                    <option value="">Seleziona categoria...</option>
                    <option value="Personale">👥 Personale</option>
                    <option value="Professionisti">🩺 Professionisti</option>
                    <option value="Utilities">⚡ Utilities</option>
                    <option value="Sicurezza">🔒 Sicurezza e Assicurazioni</option>
                    <option value="Manutenzioni">🔧 Manutenzioni</option>
                    <option value="Alimentazione">🌾 Alimentazione Animali</option>
                    <option value="Marketing">📢 Marketing</option>
                    <option value="Altri">📋 Altri Costi</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cost_name">Nome Costo</label>
                <input type="text" id="cost_name" name="name" required placeholder="es. Energia Elettrica">
            </div>
        </div>
        <div class="grid">
            <div class="form-group">
                <label for="cost_detail">Dettaglio (opzionale)</label>
                <input type="text" id="cost_detail" name="detail" placeholder="Descrizione aggiuntiva">
            </div>
            <div class="form-group">
                <label for="cost_amount">Importo Annuale (€)</label>
                <input type="number" id="cost_amount" name="amount" step="0.01" required placeholder="0.00">
            </div>
        </div>
        <button type="submit" class="btn">💾 Aggiungi</button>
    </form>
</div>

<!-- Attività -->
<div class="card">
    <div class="section-header">
        <h3 style="margin: 0; color: white;">🎯 Attività Offerte</h3>
        <span style="font-size: 1.2rem;">{{ project.activities|length }} attività</span>
    </div>

    {% set activity_groups = project.activities|groupby('category') %}
    {% for category, activities in activity_groups %}
    <h4 style="margin-top: 1.5rem; color: #764ba2;">{{ category }}</h4>
    {% for activity in activities %}
    <div class="item-card">
        <div class="item-info">
            <strong>{{ activity.name }}</strong>
            {% if activity.description %}
            <br><small style="color: #666;">{{ activity.description }}</small>
            {% endif %}
        </div>
        <form method="POST" action="{{ url_for('delete_activity', activity_id=activity.id) }}">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Sicuro di voler eliminare?')">🗑️</button>
        </form>
    </div>
    {% endfor %}
    {% endfor %}

    <h4 style="margin-top: 2rem;">➕ Aggiungi Attività</h4>
    <form method="POST" action="{{ url_for('add_activity', project_id=project.id) }}">
        <div class="grid">
            <div class="form-group">
                <label for="act_category">Categoria</label>
                <select id="act_category" name="category" required>
                    <option value="">Seleziona categoria...</option>
                    <option value="Esperienze con Animali">🐄 Esperienze con Animali</option>
                    <option value="Attività Outdoor">🚜 Attività Outdoor</option>
                    <option value="Laboratori Pratici">🧑‍🍳 Laboratori Pratici</option>
                    <option value="Eventi">🎉 Eventi e Intrattenimento</option>
                    <option value="Programmi Scolastici">📚 Programmi Scolastici</option>
                    <option value="Team Building">🤝 Team Building</option>
                    <option value="Benessere">🧘 Relax e Benessere</option>
                    <option value="Produzione">🌾 Produzione Agricola</option>
                </select>
            </div>
            <div class="form-group">
                <label for="act_name">Nome Attività</label>
                <input type="text" id="act_name" name="name" required placeholder="es. Mungitura dimostrativa">
            </div>
        </div>
        <div class="form-group">
            <label for="act_desc">Descrizione (opzionale)</label>
            <textarea id="act_desc" name="description" placeholder="Descrizione dell'attività..."></textarea>
        </div>
        <button type="submit" class="btn">💾 Aggiungi</button>
    </form>
</div>

<!-- Azioni -->
<div class="card" style="background: #fff3cd;">
    <h3>⚙️ Azioni</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('view_report', project_id=project.id) }}" class="btn">📄 Visualizza Report Completo</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">⬅️ Torna alla Lista</a>
        <form method="POST" action="{{ url_for('delete_project', project_id=project.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-danger" onclick="return confirm('ATTENZIONE: Questa azione eliminerà TUTTI i dati del progetto. Continuare?')">🗑️ Elimina Progetto</button>
        </form>
    </div>
</div>
{% endblock %}