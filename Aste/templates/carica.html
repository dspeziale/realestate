{% extends "base.html" %}

{% block title %}Carica Asta - Aste Immobiliari{% endblock %}

{% block content %}
<div class="mb-4">
    <h2><i class="bi bi-cloud-upload"></i> Carica Nuova Asta</h2>
    <p class="text-muted">Carica uno o più file JSON oppure incolla il contenuto JSON per aggiungere aste</p>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Carica File JSON</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-3">
                        <label for="files" class="form-label">Seleziona uno o più file JSON</label>
                        <input type="file" class="form-control" id="files" name="files" accept=".json" multiple required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Puoi selezionare più file contemporaneamente (Ctrl+Click o Shift+Click)
                        </div>
                    </div>

                    <div id="fileList" class="mb-3" style="display: none;">
                        <label class="form-label">File selezionati:</label>
                        <ul class="list-group" id="fileListItems"></ul>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i> Carica File
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> Incolla JSON</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="json_text" class="form-label">Contenuto JSON</label>
                        <textarea class="form-control" id="json_text" name="json_text" rows="10" required
                                  placeholder='{"info_generali": {...}, "localizzazione": {...}}'></textarea>
                        <div class="form-text">Incolla il contenuto del JSON qui</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-circle"></i> Carica JSON
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Formato JSON Richiesto</h5>
    </div>
    <div class="card-body">
        <p>Il file JSON deve contenere le seguenti sezioni:</p>
        <ul>
            <li><strong>info_generali:</strong> titolo, tipo_immobile, tipo_vendita, url, data_inserimento</li>
            <li><strong>localizzazione:</strong> indirizzo, città, CAP, zona</li>
            <li><strong>prezzi:</strong> prezzo_asta</li>
            <li><strong>caratteristiche:</strong> numero_locali, numero_bagni, piano</li>
            <li><strong>descrizione:</strong> breve e completa</li>
            <li><strong>informazioni_asta:</strong> data_asta, lotto</li>
            <li><strong>dati_catastali:</strong> foglio, particella, categoria, rendita</li>
            <li><strong>contatti:</strong> telefono</li>
        </ul>

        <div class="mt-3">
            <h6>Esempio JSON:</h6>
            <pre class="bg-light p-3 rounded"><code>{
  "info_generali": {
    "titolo": "Aste Florio",
    "tipo_immobile": "Commerciale",
    "tipo_vendita": "Asta",
    "url": "https://esempio.it",
    "data_inserimento": "2025-10-02T14:37:25.149174"
  },
  "localizzazione": {
    "indirizzo": "Via Roma 1",
    "citta": "Milano",
    "cap": "20100"
  },
  "caratteristiche": {
    "numero_locali": 3,
    "numero_bagni": 1,
    "piano": "1"
  },
  "informazioni_asta": {
    "data_asta": "08/10/2025",
    "lotto": "1"
  }
}</code></pre>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Torna alla Dashboard
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validazione JSON in tempo reale
    document.getElementById('json_text').addEventListener('input', function() {
        try {
            JSON.parse(this.value);
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } catch (e) {
            this.classList.remove('is-valid');
            if (this.value.length > 0) {
                this.classList.add('is-invalid');
            }
        }
    });

    // Mostra lista file selezionati
    document.getElementById('files').addEventListener('change', function(e) {
        const fileList = document.getElementById('fileList');
        const fileListItems = document.getElementById('fileListItems');
        const files = e.target.files;

        if (files.length > 0) {
            fileListItems.innerHTML = '';
            fileList.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                const isJson = file.name.toLowerCase().endsWith('.json');
                const badge = isJson
                    ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> JSON</span>'
                    : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Non JSON</span>';

                li.innerHTML = `
                    <span>
                        <i class="bi bi-file-earmark-text"></i> ${file.name}
                        <small class="text-muted">(${formatFileSize(file.size)})</small>
                    </span>
                    ${badge}
                `;

                fileListItems.appendChild(li);
            }

            // Conta file JSON validi
            const validFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.json')).length;
            if (validFiles === 0) {
                const warning = document.createElement('div');
                warning.className = 'alert alert-warning mt-2 mb-0';
                warning.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Nessun file JSON valido selezionato';
                fileList.appendChild(warning);
            } else {
                const info = document.createElement('div');
                info.className = 'alert alert-info mt-2 mb-0';
                info.innerHTML = `<i class="bi bi-info-circle"></i> ${validFiles} file JSON ${validFiles === 1 ? 'valido' : 'validi'} su ${files.length} ${files.length === 1 ? 'selezionato' : 'selezionati'}`;
                fileList.appendChild(info);
            }
        } else {
            fileList.style.display = 'none';
        }
    });

    // Funzione per formattare dimensione file
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Indicatore di caricamento
    document.getElementById('uploadForm').addEventListener('submit', function() {
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Caricamento...';
        btn.disabled = true;
    });
</script>
{% endblock %}