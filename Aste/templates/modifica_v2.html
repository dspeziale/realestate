{% extends "base_v2.html" %}

{% block title %}Modifica {{ asta.codice_asta }} - {{ asta.titolo }}{% endblock %}

{% block extra_css %}
<style>
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    .required::after {
        content: " *";
        color: red;
    }
    .card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('dettaglio', codice_asta=asta.codice_asta) }}" class="btn btn-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Torna al Dettaglio
    </a>
    <h2><i class="bi bi-pencil-square"></i> Modifica Asta</h2>
    <div class="info-box">
        <strong><i class="bi bi-info-circle"></i> Codice Asta:</strong> {{ asta.codice_asta }}<br>
        <strong>Data inserimento:</strong> {{ asta.data_inserimento or 'N/A' }}<br>
        <strong>Ultimo aggiornamento:</strong> {{ asta.data_aggiornamento or 'N/A' }}
    </div>
</div>

<form method="POST" id="formModifica">
    <div class="row">
        <!-- Colonna Sinistra -->
        <div class="col-lg-6">

            <!-- Informazioni Base -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informazioni Base</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label required">Titolo</label>
                        <input type="text" class="form-control" name="titolo" required
                               value="{{ asta.titolo or '' }}">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipologia Immobile</label>
                            <select class="form-select" name="tipologia_immobile">
                                <option value="">Seleziona...</option>
                                {% for tipo in ['Appartamento', 'Casa', 'Villa', 'Ufficio', 'Negozio', 'Box/Garage', 'Terreno', 'Capannone'] %}
                                <option value="{{ tipo }}" {% if asta.tipologia_immobile == tipo %}selected{% endif %}>
                                    {{ tipo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control" name="categoria"
                                   value="{{ asta.categoria or '' }}" placeholder="es. Residenziale">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">URL Annuncio</label>
                        <input type="url" class="form-control" name="url"
                               value="{{ asta.url or '' }}" placeholder="https://...">
                        <small class="text-muted">Link alla pagina originale dell'asta</small>
                    </div>
                </div>
            </div>

            <!-- Localizzazione -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Localizzazione</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Indirizzo</label>
                        <input type="text" class="form-control" name="indirizzo"
                               value="{{ asta.indirizzo or '' }}" placeholder="Via Roma 1">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Città</label>
                            <input type="text" class="form-control" name="citta"
                                   value="{{ asta.citta or '' }}" placeholder="Roma">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Provincia</label>
                            <input type="text" class="form-control" name="provincia"
                                   value="{{ asta.provincia or '' }}" placeholder="RM" maxlength="2">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">CAP</label>
                            <input type="text" class="form-control" name="cap"
                                   value="{{ asta.cap or '' }}" placeholder="00100" pattern="[0-9]{5}" maxlength="5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Caratteristiche -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-house-door"></i> Caratteristiche Immobile</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Superficie (m²)</label>
                            <input type="number" class="form-control" name="superficie_mq"
                                   value="{{ asta.superficie_mq or '' }}" step="0.01" min="0" placeholder="120">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Vani</label>
                            <input type="number" class="form-control" name="vani"
                                   value="{{ asta.vani or '' }}" step="0.5" min="0" placeholder="3">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bagni</label>
                            <input type="number" class="form-control" name="bagni"
                                   value="{{ asta.bagni or '' }}" min="0" placeholder="1">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Piano</label>
                            <input type="text" class="form-control" name="piano"
                                   value="{{ asta.piano or '' }}" placeholder="T, 1, 2...">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Classe Energetica</label>
                            <select class="form-select" name="classe_energetica">
                                <option value="">Seleziona...</option>
                                {% for classe in ['A+', 'A', 'B', 'C', 'D', 'E', 'F', 'G'] %}
                                <option value="{{ classe }}" {% if asta.classe_energetica == classe %}selected{% endif %}>
                                    {{ classe }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Stato</label>
                            <select class="form-select" name="stato_immobile">
                                <option value="">Seleziona...</option>
                                {% for stato in ['Buono', 'Ottimo', 'Da ristrutturare', 'Nuovo'] %}
                                <option value="{{ stato }}" {% if asta.stato_immobile == stato %}selected{% endif %}>
                                    {{ stato }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Disponibilità</label>
                        <select class="form-select" name="disponibilita">
                            <option value="">Seleziona...</option>
                            {% for disp in ['Libero', 'Occupato', 'Parzialmente occupato'] %}
                            <option value="{{ disp }}" {% if asta.disponibilita == disp %}selected{% endif %}>
                                {{ disp }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Descrizione -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Descrizione</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Descrizione Breve</label>
                        <textarea class="form-control" name="descrizione_breve" rows="3"
                                  placeholder="Breve descrizione dell'immobile...">{{ asta.descrizione_breve or '' }}</textarea>
                        <small class="text-muted">Max 500 caratteri consigliati</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descrizione Completa</label>
                        <textarea class="form-control" name="descrizione_completa" rows="6"
                                  placeholder="Descrizione dettagliata...">{{ asta.descrizione_completa or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonna Destra -->
        <div class="col-lg-6">

            <!-- Dati Vendita -->
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-gavel"></i> Dati della Vendita</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Vendita</label>
                            <input type="date" class="form-control" name="data_vendita"
                                   value="{{ asta.data_vendita or '' }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo Vendita</label>
                            <select class="form-select" name="tipo_vendita">
                                {% for tipo in ['Asta giudiziaria', 'Vendita senza incanto', 'Asta telematica'] %}
                                <option value="{{ tipo }}" {% if asta.tipo_vendita == tipo %}selected{% endif %}>
                                    {{ tipo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Modalità Vendita</label>
                        <input type="text" class="form-control" name="modalita_vendita"
                               value="{{ asta.modalita_vendita or '' }}" placeholder="Sincrona mista">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prezzo Base (€)</label>
                            <input type="number" class="form-control" name="prezzo_base"
                                   value="{{ asta.prezzo_base or '' }}" step="0.01" min="0" placeholder="100000">
                            <small class="text-muted">Solo numero</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prezzo Base (formato)</label>
                            <input type="text" class="form-control" name="prezzo_base_formatted"
                                   value="{{ asta.prezzo_base_formatted or '' }}" placeholder="€ 100.000,00" readonly>
                            <small class="text-muted">Auto-calcolato</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Procedura -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bank"></i> Dettaglio Procedura</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Tribunale</label>
                        <input type="text" class="form-control" name="tribunale"
                               value="{{ asta.tribunale or '' }}" placeholder="Tribunale di Roma">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo Procedura</label>
                            <select class="form-select" name="tipo_procedura">
                                <option value="">Seleziona...</option>
                                {% for tipo in ['Esecuzione immobiliare', 'Fallimento', 'Liquidazione coatta'] %}
                                <option value="{{ tipo }}" {% if asta.tipo_procedura == tipo %}selected{% endif %}>
                                    {{ tipo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Numero RGE</label>
                            <input type="text" class="form-control" name="numero_rge"
                                   value="{{ asta.numero_rge or '' }}" placeholder="123">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Anno RGE</label>
                            <input type="text" class="form-control" name="anno_rge"
                                   value="{{ asta.anno_rge or '' }}" placeholder="2024" pattern="[0-9]{4}" maxlength="4">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delegato -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0 text-white"><i class="bi bi-person-badge"></i> Delegato alla Vendita</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" name="delegato_nome"
                                   value="{{ asta.delegato_nome or '' }}" placeholder="Mario">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cognome</label>
                            <input type="text" class="form-control" name="delegato_cognome"
                                   value="{{ asta.delegato_cognome or '' }}" placeholder="Rossi">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefono</label>
                            <input type="tel" class="form-control" name="delegato_telefono"
                                   value="{{ asta.delegato_telefono or '' }}" placeholder="+39 06 1234567">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="delegato_email"
                                   value="{{ asta.delegato_email or '' }}" placeholder="email@example.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custode -->
            <div class="card mb-4">
                <div class="card-header bg-success">
                    <h5 class="mb-0 text-white"><i class="bi bi-shield-check"></i> Custode Giudiziario</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" name="custode_nome"
                                   value="{{ asta.custode_nome or '' }}" placeholder="Luigi">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cognome</label>
                            <input type="text" class="form-control" name="custode_cognome"
                                   value="{{ asta.custode_cognome or '' }}" placeholder="Bianchi">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefono</label>
                            <input type="tel" class="form-control" name="custode_telefono"
                                   value="{{ asta.custode_telefono or '' }}" placeholder="+39 06 7654321">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="custode_email"
                                   value="{{ asta.custode_email or '' }}" placeholder="custode@example.com">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pulsanti Azione -->
    <div class="row">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-2 mb-md-0">
                            <a href="{{ url_for('dettaglio', codice_asta=asta.codice_asta) }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Annulla
                            </a>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-arrow-left"></i> Dashboard
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> Elimina
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="btnSalva">
                                <i class="bi bi-check-circle"></i> Salva Modifiche
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal Conferma Eliminazione -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare definitivamente questa asta?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Attenzione:</strong>
                    Questa azione non può essere annullata. Verranno eliminati anche:
                    <ul class="mb-0 mt-2">
                        <li>Tutti gli allegati</li>
                        <li>Tutte le foto</li>
                        <li>Tutte le planimetrie</li>
                        <li>Lo storico vendite</li>
                    </ul>
                </div>
                <div class="bg-light p-3 rounded">
                    <p class="mb-1"><strong>Codice:</strong> {{ asta.codice_asta }}</p>
                    <p class="mb-0"><strong>Titolo:</strong> {{ asta.titolo }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annulla
                </button>
                <form method="POST" action="{{ url_for('elimina', codice_asta=asta.codice_asta) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Elimina Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Validazione form
    $('#formModifica').on('submit', function(e) {
        const titolo = $('input[name="titolo"]').val().trim();

        if (!titolo) {
            e.preventDefault();
            alert('Il titolo è obbligatorio');
            $('input[name="titolo"]').focus();
            return false;
        }

        // Validazione CAP
        const cap = $('input[name="cap"]').val().trim();
        if (cap && !/^\d{5}$/.test(cap)) {
            e.preventDefault();
            alert('Il CAP deve essere di 5 cifre');
            $('input[name="cap"]').focus();
            return false;
        }

        // Validazione anno RGE
        const annoRge = $('input[name="anno_rge"]').val().trim();
        if (annoRge && !/^\d{4}$/.test(annoRge)) {
            e.preventDefault();
            alert('L\'anno RGE deve essere di 4 cifre');
            $('input[name="anno_rge"]').focus();
            return false;
        }

        // Disabilita pulsante
        $('#btnSalva').prop('disabled', true)
                      .html('<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...');
    });

    // Auto-formattazione prezzo quando si modifica il campo numerico
    $('input[name="prezzo_base"]').on('blur', function() {
        const val = $(this).val();
        if (val) {
            const formatted = new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(val);
            $('input[name="prezzo_base_formatted"]').val(formatted);
        }
    });

    // Validazione provincia (forza maiuscolo e max 2 caratteri)
    $('input[name="provincia"]').on('input', function() {
        this.value = this.value.toUpperCase().slice(0, 2);
    });

    // Conferma prima di uscire se ci sono modifiche non salvate
    let formModificato = false;

    $('#formModifica input, #formModifica select, #formModifica textarea').on('change input', function() {
        formModificato = true;
    });

    $('a[href]').not('[data-bs-toggle]').not('[href^="#"]').on('click', function(e) {
        if (formModificato) {
            if (!confirm('Hai modifiche non salvate. Vuoi davvero uscire?')) {
                e.preventDefault();
                return false;
            }
        }
    });

    // Reset flag dopo submit
    $('#formModifica').on('submit', function() {
        formModificato = false;
    });

    // Evidenzia campo quando riceve focus
    $('input, select, textarea').on('focus', function() {
        $(this).addClass('border-primary');
    }).on('blur', function() {
        $(this).removeClass('border-primary');
    });

    // Contatore caratteri per descrizione breve
    $('textarea[name="descrizione_breve"]').on('input', function() {
        const len = $(this).val().length;
        const max = 500;

        if (len > max) {
            if (!$(this).next('.char-counter').length) {
                $(this).after('<small class="char-counter text-danger">Superati ' + max + ' caratteri consigliati (' + len + '/' + max + ')</small>');
            } else {
                $(this).next('.char-counter').text('Superati ' + max + ' caratteri consigliati (' + len + '/' + max + ')');
            }
        } else {
            $(this).next('.char-counter').remove();
        }
    });
});
</script>
{% endblock %}