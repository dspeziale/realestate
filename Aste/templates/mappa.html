{% extends "base_v2.html" %}

{% block title %}Mappa Aste - Aste Immobiliari{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
    #mapContainer {
        height: calc(100vh - 200px);
        min-height: 600px;
    }
    .leaflet-popup-content {
        min-width: 250px;
    }
    .popup-title {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
    }
    .popup-info {
        font-size: 0.9rem;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Torna alla Dashboard
    </a>
    <h2 class="mt-3"><i class="bi bi-map"></i> Mappa delle Aste Immobiliari</h2>
    <p class="text-muted">Visualizzazione geografica delle aste con coordinate GPS</p>
</div>

<div class="card">
    <div class="card-body p-0">
        <div id="mapContainer"></div>
    </div>
</div>

<div class="mt-3">
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Legenda:</strong> Clicca sui marker per visualizzare i dettagli dell'asta.
        I cluster numerati raggruppano più aste nella stessa zona.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// Dati aste passati dal backend
const asteData = {{ aste|safe }};

// Inizializza mappa
const map = L.map('mapContainer').setView([41.9028, 12.4964], 6); // Centro Italia

// Tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Cluster group per raggruppare marker vicini
const markers = L.markerClusterGroup({
    maxClusterRadius: 50,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
});

// Aggiungi marker per ogni asta
asteData.forEach(function(asta) {
    if (asta.lat && asta.lng) {
        const marker = L.marker([asta.lat, asta.lng]);

        // Popup con info asta
        const popupContent = `
            <div class="popup-content">
                <div class="popup-title">${asta.titolo || 'N/A'}</div>
                <div class="popup-info">
                    <strong>Codice:</strong> ${asta.codice}<br>
                    <strong>Città:</strong> ${asta.citta || 'N/A'}<br>
                    <strong>Indirizzo:</strong> ${asta.indirizzo || 'N/A'}<br>
                    <strong>Prezzo:</strong> <span class="text-warning">${asta.prezzo || 'N/A'}</span><br>
                    <div class="mt-2">
                        <a href="/dettaglio/${asta.codice}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> Vedi Dettagli
                        </a>
                    </div>
                </div>
            </div>
        `;

        marker.bindPopup(popupContent);
        markers.addLayer(marker);
    }
});

// Aggiungi cluster alla mappa
map.addLayer(markers);

// Se ci sono aste, zoom automatico per mostrarle tutte
if (asteData.length > 0) {
    const bounds = markers.getBounds();
    if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

// Info contatore
console.log(`Visualizzate ${asteData.length} aste sulla mappa`);
</script>
{% endblock %}